
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover" />
  <title>ë¶€íƒœë¦¬ì˜ ì—°ë´‰+ìì‚° ê¸°ì¤€ íˆ¬ìë‹¨ì§€ ì°¾ê¸°</title>
  <style>
    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --sub:#6b7280;
      --brand:#4f46e5;
      --brand-50:#eef2ff;
      --brand-200:#c7d2fe;
      --ok-bg:#ecfdf5;
      --ok-bd:#a7f3d0;
      --warn-bg:#fff7ed;
      --warn-bd:#fde68a;
      --err-bg:#fee2e2;
      --err-bd:#fecaca;
      --yellow:#FEF08A;
      --shadow:0 2px 8px rgba(0,0,0,.06);
      --radius:12px;
    }

    /* âœ… ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ UX */
    html{ scroll-behavior:smooth; }
    html,body{height:100%;}
    body{
      overscroll-behavior-y:contain;
      -webkit-overflow-scrolling:touch;

      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", Arial, sans-serif;
      color:var(--text);
      background:var(--bg);
      max-width: 760px;
      width: 100%;
      margin: 0 auto;
      padding: 18px; /* ì‚´ì§ ì¦ê°€ */
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      line-height: 1.55;
    }

    h2{ text-align:center; margin: 8px 0 18px; font-weight:800; }
    label{ font-weight: 700; margin-top: 10px; display:block; }
    input, select, button{
      width: 100%;
      padding: 14px 12px;
      margin-bottom: 12px;
      font-size: 1rem;
      box-sizing: border-box;
      border:1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      outline: none;
    }
    input:focus, select:focus, button:focus{ box-shadow: 0 0 0 3px rgba(79,70,229,.18); }
    input[type="checkbox"], input[type="radio"]{ width:auto; margin-right: 6px; }
    .checkbox-label{ display:flex; align-items:center; gap:8px; margin:6px 0; font-size:0.97rem; flex-wrap: wrap; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row-1{ display:grid; grid-template-columns: 1fr; gap:10px; }

    .box{
      position: relative;       /* ì„¹ì…˜ ê·¸ë¼ë°ì´ì…˜ ê³ ì •ìš© */
      background:var(--card);
      border-radius: var(--radius);
      padding: 16px;            /* â†‘ */
      margin: 14px 0 18px;      /* â†‘ ì„¹ì…˜ ê°„ê²© */
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      scroll-margin-top: 14px;  /* ì•µì»¤ ì´ë™ ì‹œ ìƒë‹¨ ì—¬ë°± */
      overflow: visible;
    }

    /* âœ… ì„¹ì…˜ í•˜ë‹¨ ê·¸ë¼ë°ì´ì…˜ + í™”ì‚´í‘œ (ê¸°ë³¸ ìˆ¨ê¹€, JSë¡œ í† ê¸€) */
    .section-fade{
      position:absolute;
      left:-1px; right:-1px; bottom:-1px;
      height:40px;
      background: linear-gradient(to top, var(--card) 70%, rgba(255,255,255,0));
      pointer-events:none;
      display:none;
      border-bottom-left-radius: var(--radius);
      border-bottom-right-radius: var(--radius);
    }
    .section-fade svg{
      position:absolute;
      left:50%; transform:translateX(-50%);
      bottom:6px;
      width:20px; height:20px; opacity:.45;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,.15));
    }
    .section-fade.show{ display:block; }

    .result{
      background:var(--card);
      border-radius: var(--radius);
      padding: 16px;
      margin-top: 16px;
      font-size: 0.98rem;
      line-height: 1.65;
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      overflow-wrap:anywhere;
    }
    .subtle{ font-size: 0.92rem; color: var(--sub); }
    .hangul{ font-size: 0.92rem; color: var(--sub); display:block; margin-top:-6px; margin-bottom:8px; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:#f1f5f9; border:1px solid #e5e7eb; font-size:12px; margin:2px 6px 2px 0; white-space:nowrap; }
    .ok{ color:#065f46; background:var(--ok-bg); border:1px solid var(--ok-bd); padding:10px; border-radius:8px; }
    .warn{ color:#b45309; background:var(--warn-bg); border:1px solid var(--warn-bd); padding:10px; border-radius:8px; }
    .error{ color:#991b1b; background:var(--err-bg); border:1px solid var(--err-bd); padding:10px; border-radius:8px; }
    .section-title{ font-weight: 800; margin:14px 0 8px; font-size:1.05rem; }
    .calculation-steps{ background:#f3f4f6; border-left:4px solid #10b981; padding:12px; margin:15px 0; font-size:0.94rem; border-radius: 0 10px 10px 0; }
    .hide{ display:none; }
    footer{ margin: 28px 0 18px; text-align:center; font-size:0.9rem; color:#555; }
    footer a{ color:#374151; text-decoration:none; font-weight:700; }

    /* âœ… ê°•ì¡° ë°•ìŠ¤ */
    .highlight-card{
      background:var(--brand-50);
      border:1px solid var(--brand-200);
      border-left:6px solid var(--brand);
      border-radius:14px;
      padding:16px 16px;
      box-shadow: var(--shadow);
      margin:12px 0 14px;
    }
    .highlight-primary{
      font-weight:800;
      font-size:1.08rem;
      line-height:1.5;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .highlight-primary .amount{
      display:inline-block;
      font-size:1.9rem;
      font-weight:900;
      background:var(--yellow);
      padding:3px 8px;
      border-radius:8px;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,0.06);
      line-height:1.2;
    }
    .elig-badge{
      display:inline-block;
      padding:4px 10px;
      font-weight:900;
      font-size:0.92rem;
      color:#991b1b;
      background:#fee2e2;
      border:1px solid #fecaca;
      border-radius:999px;
      vertical-align:middle;
    }
    .highlight-secondary{
      margin-top:8px;
      font-size:1.06rem;
      color:#111827;
      font-weight:700;
    }

    /* âœ… ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 480px){
      body{ padding: 14px; }
      .row{ grid-template-columns: 1fr; gap:8px; }
      input, select, button{ font-size:1.02rem; padding: 16px 12px; }
      .box{ padding:14px; }
      .section-title{ font-size:1.04rem; }
      .highlight-primary{ font-size:1.02rem; }
      .highlight-primary .amount{ font-size:2.1rem; }
      .highlight-secondary{ font-size:1.02rem; }
      .result{ font-size:1rem; }
    }

    /* âœ… ê¸°ë³¸ ë²„íŠ¼ */
    .btn-primary{
      background:#4f46e5; color:#fff; border: none; font-weight: 900; letter-spacing:.2px;
      padding: 14px 16px; border-radius: 12px; cursor: pointer; margin-top: 4px;
      box-shadow: 0 6px 18px rgba(79,70,229,.18);
    }
    .btn-primary:active{ transform: translateY(1px); }

    /* âœ… í˜ì´ì§€ í•˜ë‹¨ ìŠ¤í¬ë¡¤ íŒíŠ¸(ê³ ì •) */
    .scroll-hint{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: 56px;
      background: linear-gradient(to top, var(--bg) 70%, rgba(248,250,252,0));
      padding-bottom: env(safe-area-inset-bottom, 0);
      pointer-events: none;
      z-index: 9999;
      display: block;
    }
    .scroll-hint.hide{ display:none; }
    .scroll-hint svg{
      position: absolute;
      left: 50%;
      bottom: calc(8px + env(safe-area-inset-bottom, 0));
      transform: translateX(-50%);
      width: 22px; height: 22px; opacity: .55;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,.15));
    }
  </style>
</head>
<body>
  <h2>ë¶€íƒœë¦¬ì˜ íˆ¬ìë‹¨ì§€ ì°¾ê¸° + ëŒ€ì¶œ ê³„ì‚°ê¸°</h2>

  <div class="box">
    <div class="section-title">â‘  ê¸°ë³¸ ì…ë ¥</div>
    <label>ì—°ë´‰ (ë§Œì›)</label>
    <input type="number" id="income" inputmode="numeric" pattern="[0-9]*" oninput="updateHangulAmount('income')">
    <span id="incomeText" class="hangul"></span>

    <label>ê°€ì§„ ìì‚° (ë§Œì›)</label>
    <input type="number" id="assets" inputmode="numeric" pattern="[0-9]*" oninput="updateHangulAmount('assets')">
    <span id="assetsText" class="hangul"></span>

    <div class="row">
      <div>
        <label>ëŒ€ì¶œ ê¸ˆë¦¬ (ì—° %, ì†Œìˆ˜ì  ê°€ëŠ¥)</label>
        <input type="number" id="interestRate" step="0.01" inputmode="decimal" value="3.5">
      </div>
      <div>
        <label>ìƒí™˜ ê¸°ê°„ (ë…„)</label>
        <input type="number" id="loanTerm" inputmode="numeric" pattern="[0-9]*" value="30">
      </div>
    </div>

    <label>ê¸°ì¡´ ëŒ€ì¶œ ì›” ìƒí™˜ê¸ˆ (ë§Œì›)</label>
    <input type="number" id="existingLoanMonthly" inputmode="numeric" pattern="[0-9]*" value="0">

    <!-- ì„¹ì…˜ ê·¸ë¼ë°ì´ì…˜ -->
    <div class="section-fade" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M6 9l6 6 6-6" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>

  <div class="box">
    <div class="section-title">â‘¡ ëŒ€ì¶œ êµ¬ë¶„</div>
    <div class="checkbox-label"><input type="radio" name="loanDomain" value="bank" checked onclick="switchDomain()"> ê¸ˆìœµê¶Œ ëŒ€ì¶œ</div>
    <div class="checkbox-label"><input type="radio" name="loanDomain" value="policy" onclick="switchDomain()"> ì •ì±…ì„± ëŒ€ì¶œ(ë””ë”¤ëŒ/ë³´ê¸ˆìë¦¬ë¡ )</div>

    <!-- ì„¹ì…˜ ê·¸ë¼ë°ì´ì…˜ -->
    <div class="section-fade" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M6 9l6 6 6-6" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>

  <!-- ê¸ˆìœµê¶Œ ì˜µì…˜ -->
  <div id="bankPanel" class="box">
    <div class="section-title">ê¸ˆìœµê¶Œ ì„¸ë¶€ ì„ íƒ</div>
    <div class="checkbox-label"><input type="radio" name="bankBorrower" value="general" checked> ì¼ë°˜ì°¨ì£¼</div>
    <div class="checkbox-label"><input type="radio" name="bankBorrower" value="first"> ìƒì• ìµœì´ˆ</div>
    <div class="checkbox-label">
      <input type="radio" name="bankBorrower" value="seomin"> ì„œë¯¼Â·ì‹¤ìˆ˜ìš”ì
      <span class="subtle">ì—°ì†Œë“ 9ì²œâ†“, ì£¼íƒê°€ê²© 8ì–µâ†“, ë¬´ì£¼íƒ</span>
    </div>

    <div class="row-1">
      <div>
        <label>ê¸ˆìœµê¶Œ êµ¬ë¶„</label>
        <select id="bankTier">
          <option value="tier1">1ê¸ˆìœµê¶Œ (DSR 40%)</option>
          <option value="tier2">2ê¸ˆìœµê¶Œ (DSR 50%)</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:4px;">
      <label class="checkbox-label" style="margin-bottom:0;">
        <input type="checkbox" id="speculativeArea"> íˆ¬ê¸°ê³¼ì—´ì§€êµ¬
      </label>
      <label class="checkbox-label" style="margin-bottom:0;">
        <input type="checkbox" id="capitalArea" onchange="updateCapitalInfo()"> ìˆ˜ë„ê¶Œ ì—¬ë¶€
        <span class="subtle">DSR ìŠ¤íŠ¸ë ˆìŠ¤ +3%</span>
      </label>
    </div>
    <div id="stressAutoInfo" class="ok hide" style="margin:8px 0;">ìˆ˜ë„ê¶Œìœ¼ë¡œ íŒë‹¨ë˜ì–´ DSR ìŠ¤íŠ¸ë ˆìŠ¤ ê¸ˆë¦¬ <b>+3%</b>ê°€ ìë™ ì ìš©ë©ë‹ˆë‹¤.</div>

    <!-- ì„¹ì…˜ ê·¸ë¼ë°ì´ì…˜ -->
    <div class="section-fade" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M6 9l6 6 6-6" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>

  <!-- ì •ì±…ì„± ì˜µì…˜ -->
  <div id="policyPanel" class="box hide">
    <div class="section-title">ì •ì±…ì„± ëŒ€ì¶œ ì„ íƒ</div>
    <div class="checkbox-label"><input type="radio" name="policyType" value="didim" checked onclick="switchPolicy()"> ë””ë”¤ëŒ ëŒ€ì¶œ</div>
    <div class="checkbox-label"><input type="radio" name="policyType" value="bogum" onclick="switchPolicy()"> ë³´ê¸ˆìë¦¬ë¡ </div>

    <div id="didimPanel" class="box" style="margin:10px 0 0;">
      <div class="section-title">ë””ë”¤ëŒ ì„¸ë¶€</div>
      <div class="checkbox-label"><input type="radio" name="didimKind" value="normal" checked> ì¼ë°˜(LTV 70%, í•œë„ 2ì–µ, ê°€ê²© â‰¤5ì–µ)</div>
      <div class="checkbox-label"><input type="radio" name="didimKind" value="first"> ìƒì• ìµœì´ˆ(LTV 70%, í•œë„ 2.4ì–µ, ê°€ê²© â‰¤5ì–µ)</div>
      <!-- âœ… ì‹ í˜¼, 2ìë…€ ë¶„ë¦¬ -->
      <div class="checkbox-label"><input type="radio" name="didimKind" value="newlyweds"> ì‹ í˜¼(LTV 70%, í•œë„ 3.2ì–µ, ê°€ê²© â‰¤6ì–µ, ì†Œë“ â‰¤8,500ë§Œì›)</div>
      <div class="checkbox-label"><input type="radio" name="didimKind" value="twokids"> 2ìë…€(LTV 70%, í•œë„ 3.2ì–µ, ê°€ê²© â‰¤6ì–µ, ì†Œë“ â‰¤7,000ë§Œì›)</div>
      <div class="checkbox-label"><input type="radio" name="didimKind" value="newborn"> ì‹ ìƒì•„(LTV 70%, í•œë„ 4ì–µ, ê°€ê²© â‰¤5ì–µ)</div>
      <div class="subtle">ì†Œë“Â·ìˆœìì‚° ìš”ê±´(ìš”ì•½): ì¼ë°˜ 6ì²œ, ìƒì• ìµœì´ˆ 7ì²œ, <b>ì‹ í˜¼ 8.5ì²œ</b>, <b>2ìë…€ 7ì²œ</b>, ì‹ ìƒì•„ 7ì²œ / ìˆœìì‚° 4.88ì–µâ†“</div>

      <div class="section-fade" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 9l6 6 6-6" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>

    <div id="bogumPanel" class="box hide" style="margin:10px 0 0;">
      <div class="section-title">ë³´ê¸ˆìë¦¬ë¡  ì„¸ë¶€</div>
      <div class="checkbox-label"><input type="radio" name="bogumKind" value="normal" checked> ì¼ë°˜(LTV 60%, í•œë„ 3.6ì–µ, ê°€ê²© â‰¤6ì–µ)</div>
      <div class="checkbox-label"><input type="radio" name="bogumKind" value="first"> ìƒì• ìµœì´ˆ(LTV 70%, í•œë„ 4.2ì–µ, ê°€ê²© â‰¤6ì–µ)</div>
      <div class="row">
        <div>
          <label>ë¹„(é)ì•„íŒŒíŠ¸ ì—¬ë¶€</label>
          <select id="bogumNonApt">
            <option value="no" selected>ì•„íŒŒíŠ¸</option>
            <option value="yes">ë¹„ì•„íŒŒíŠ¸ (LTV -5%p)</option>
          </select>
        </div>
      </div>
      <div class="subtle">ì†Œë“ ìš”ê±´: ë¶€ë¶€í•©ì‚° ì—° 7ì²œë§Œì› ì´í•˜, ë¬´ì£¼íƒ ë˜ëŠ” 1ì£¼íƒ</div>

      <div class="section-fade" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 9l6 6 6-6" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>

    <div class="section-fade" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M6 9l6 6 6-6" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>

  <!-- ê¸°ë³¸(ë¹„-ê³ ì •) ë²„íŠ¼ -->
  <button class="btn-primary" onclick="calculate()">ê³„ì‚°í•˜ê¸°</button>

  <div id="eligibility"></div>
  <div id="result" class="result hide"></div>
  <div id="calculationSteps" class="calculation-steps hide"></div>

  <footer>
    <a href="https://blog.naver.com/landlover333" target="_blank">ë¶€íƒœë¦¬ ë¸”ë¡œê·¸</a> | Made by ë¶€íƒœë¦¬ (2025)
  </footer>

  <!-- âœ… í˜ì´ì§€ í•˜ë‹¨ ìŠ¤í¬ë¡¤ íŒíŠ¸(ê³ ì •) -->
  <div class="scroll-hint" aria-hidden="true">
    <svg viewBox="0 0 24 24" fill="none">
      <path d="M6 9l6 6 6-6" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>

  <script>
    // ---- ìœ í‹¸ ----
    function formatAmount(num){
      if(!num && num!==0) return '';
      const oku=Math.floor(num/10000), man=num%10000;
      return (oku>0?(oku+'ì–µ '):'')+(man>0?(man+'ë§Œì›'):(oku>0?'ì›':'0'));
    }
    function eok(n){ return (n/10000).toFixed(2); }
    function updateHangulAmount(id){
      const v=parseFloat(document.getElementById(id).value||0);
      document.getElementById(id+'Text').textContent = v>0 ? formatAmount(Math.floor(v)) : '';
    }
    function monthlyPayment(principal, annualRate, months){
      const r=annualRate/12;
      if(r===0) return principal/months;
      return principal*r*Math.pow(1+r,months)/(Math.pow(1+r,months)-1);
    }
    function updateCapitalInfo(){
      const cap=document.getElementById('capitalArea').checked;
      document.getElementById('stressAutoInfo').classList.toggle('hide',!cap);
    }
    function switchDomain(){
      const d=document.querySelector('input[name="loanDomain"]:checked').value;
      document.getElementById('bankPanel').classList.toggle('hide',d!=='bank');
      document.getElementById('policyPanel').classList.toggle('hide',d!=='policy');
      if(d==='policy') switchPolicy();
      // ì„¹ì…˜ íŒíŠ¸ ë‹¤ì‹œ í‰ê°€
      requestAnimationFrame(updateSectionFades);
    }
    function switchPolicy(){
      const p=document.querySelector('input[name="loanDomain"]:checked')?.value==='policy'
        ? document.querySelector('input[name="policyType"]:checked').value
        : null;
      if(!p) return;
      document.getElementById('didimPanel').classList.toggle('hide',p!=='didim');
      document.getElementById('bogumPanel').classList.toggle('hide',p!=='bogum');
      requestAnimationFrame(updateSectionFades);
    }

    // ---- ë©”ì¸ ê³„ì‚° ----
    function calculate(){
      const income=parseFloat(document.getElementById('income').value||0);        // ë§Œì›/ë…„
      const assets=parseFloat(document.getElementById('assets').value||0);        // ë§Œì›
      const rate=parseFloat(document.getElementById('interestRate').value||0)/100;
      const years=parseInt(document.getElementById('loanTerm').value||0);
      const months=years*12;
      const existMo=parseFloat(document.getElementById('existingLoanMonthly').value||0);

      if(!income||!assets||!rate||!years){ alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”'); return; }

      const domain=document.querySelector('input[name="loanDomain"]:checked').value;
      const isCapital=(domain==='bank' && document.getElementById('capitalArea').checked);

      // ê³µí†µ: DTI/DSR/LTV ê¸°ë³¸ì¹˜
      let dti=0, dsr=0, ltv=0, productCap=Infinity, priceLimit=Infinity, incomeLimit=Infinity;

      if(domain==='bank'){
        const borrower=document.querySelector('input[name="bankBorrower"]:checked').value;
        const tier=document.getElementById('bankTier').value;
        const spec=document.getElementById('speculativeArea').checked;

        if(borrower==='general'){ ltv = spec?0.4:0.7; dti = spec?0.4:0.5; }
        else if(borrower==='first'){ ltv=0.7; dti=0.6; }
        else { ltv=spec?0.6:0.8; dti=0.6; priceLimit=80000; incomeLimit=9000; }

        dsr = (tier==='tier1')?0.4:0.5;
      }else{
        const p=document.querySelector('input[name="policyType"]:checked').value;
        if(p==='didim'){
          const k=document.querySelector('input[name="didimKind"]:checked').value;
          ltv=0.7; dti=0.6; dsr=0;
          if(k==='normal'){ productCap=20000; priceLimit=50000; incomeLimit=6000; }
          else if(k==='first'){ productCap=24000; priceLimit=50000; incomeLimit=7000; }
          else if(k==='newlyweds'){ productCap=32000; priceLimit=60000; incomeLimit=8500; }
          else if(k==='twokids'){  productCap=32000; priceLimit=60000; incomeLimit=7000; }
          else { productCap=40000; priceLimit=50000; incomeLimit=7000; } // ì‹ ìƒì•„
        }else{
          const k=document.querySelector('input[name="bogumKind"]:checked').value;
          const nonApt=document.getElementById('bogumNonApt').value==='yes';
          if(k==='normal'){ ltv=nonApt?0.55:0.6; productCap=36000; }
          else { ltv=nonApt?0.65:0.7; productCap=42000; }
          dti=0.6; dsr=0; priceLimit=60000; incomeLimit=7000;
        }
      }

      // 1) DTI í•œë„
      const a = monthlyPayment(1, rate, months); // 1ë§Œì› ëŒ€ì¶œë‹¹ ì—° ìƒí™˜ì•¡(ë§Œì›)
      const dtiLimit = (income * dti) / (a * 12); // ë§Œì›

      // 2) DSR í•œë„ (ìˆ˜ë„ê¶Œ ìŠ¤íŠ¸ë ˆìŠ¤ +3% ë°˜ì˜)
      let dsrLimit = Infinity, dsrLimitNoStress = Infinity;
      if(dsr>0){
        const stressRate = isCapital ? (rate+0.03) : rate;
        const maxMo = (income/12) * dsr - (existMo||0);
        if(maxMo>0){
          const f = (r,m) => (r===0)? maxMo*m : maxMo*(1-Math.pow(1+r, -m))/r;
          dsrLimit       = f(stressRate/12, months);
          dsrLimitNoStress = f(rate/12, months);
        }else{
          dsrLimit = dsrLimitNoStress = 0;
        }
      }

      // 3) LTV í•œë„ (ìì‚° ê¸°ë°˜ ì—­ì‚°: ìì‚° * ltv/(1-ltv))
      const ltvLimitNew = (ltv > 0 && ltv < 1)
        ? (assets * (ltv / (1 - ltv)))
        : Infinity;

      // 4) ì ˆëŒ€ ë„˜ì„ ìˆ˜ ì—†ëŠ” 1ì°¨ ëŒ€ì¶œí•œë„ (DTI/DSR/LTV/ìƒí’ˆ ìµœì†Œê°’)
      const hardCaps = [
        {t:'DTI', v:dtiLimit},
        ...(dsr>0 ? [{t:'DSR', v:dsrLimit}] : []),
        {t:'LTV', v:ltvLimitNew},
        ...(isFinite(productCap) ? [{t:'ìƒí’ˆí•œë„', v:productCap}] : [])
      ];
      const minHard = hardCaps.reduce((m,c)=> c.v<m.v?c:m, hardCaps[0]);
      const prelimLoan = minHard.v; // ë§Œì›

      // ---- ë„ë©”ì¸ë³„ ìµœì í™” ----
      let finalLoan = prelimLoan;          // ë§Œì›
      let investable = assets + finalLoan; // ë§Œì›
      let usedAssets = Math.max(0, investable - finalLoan);
      let reason = minHard.t;

      // (A) ê¸ˆìœµê¶Œ: ê°€ê²©êµ¬ê°„ë³„ ëŒ€ì¶œìº¡(6/4/2ì–µ) - íˆ¬ê¸°ê³¼ì—´ì§€êµ¬ ì„ íƒ ì‹œì—ë§Œ ì ìš©
      let priceBandNote = '';
      let wasBandCapped = false;
      const spec=document.getElementById('speculativeArea').checked;
      if(domain==='bank' && spec){
        const bands = [
          {name:'â‰¤15ì–µ', capLoan:60000,  pMin:0,      pMax:150000},
          {name:'15~25ì–µ', capLoan:40000, pMin:150001, pMax:250000},
          {name:'>25ì–µ',  capLoan:20000,  pMin:250001, pMax:Infinity}
        ];

        const candidates=[];
        for(const b of bands){
          const loanHere = Math.min(prelimLoan, b.capLoan);
          if(loanHere<=0) continue;
          let possibleP = loanHere + assets;
          possibleP = Math.min(possibleP, b.pMax);
          if(b.pMin>0 && possibleP < b.pMin) continue;
          const assetsNeed = Math.max(0, possibleP - loanHere);
          candidates.push({band:b.name, loan:loanHere, P:possibleP, A:assetsNeed, cap:b.capLoan});
        }

        if(candidates.length>0){
          candidates.sort((x,y)=> (y.P-x.P) || (x.A-y.A) || (y.loan-x.loan));
          const best=candidates[0];
          wasBandCapped = (best.loan < prelimLoan) || (best.loan === best.cap);
          finalLoan=best.loan; investable=best.P; usedAssets=best.A;
          reason = wasBandCapped ? 'ê°€ê²©êµ¬ê°„ ëŒ€ì¶œìº¡' : reason;
          priceBandNote = `ê°€ê²©êµ¬ê°„ '${best.band}' ìµœì  ì„ íƒ: ëŒ€ì¶œ ${eok(best.loan)}ì–µ, ìì‚° ${eok(best.A)}ì–µ â†’ íˆ¬ì ${eok(best.P)}ì–µ`;
        }

        if(priceLimit<Infinity && investable>priceLimit){
          investable = priceLimit;
          finalLoan  = Math.min(finalLoan, investable - usedAssets);
          reason='ê°€ê²©í•œë„';
        }

        // ê°€ê²©êµ¬ê°„ ìº¡ì´ ê±¸ë¦° ê²½ìš°ì—ë§Œ ìµœì¢… ê¸ˆì•¡ì— LTV ì¬ì ìš©
        if (wasBandCapped && ltv > 0) {
          const ltvLimitAfterBand = ltv * investable; // ë§Œì›
          if (finalLoan > ltvLimitAfterBand) {
            finalLoan  = ltvLimitAfterBand;
            investable = assets + finalLoan;
            usedAssets = Math.max(0, investable - finalLoan);
            reason     = 'LTV(ê°€ê²©êµ¬ê°„ í›„)';
          }
        }
      }

      // (B) ì •ì±…ì„±
      if(domain==='policy'){
        const loanByCap = (productCap<Infinity)? Math.min(prelimLoan, productCap) : prelimLoan;
        finalLoan = loanByCap;
        investable = Math.min(assets + finalLoan, priceLimit);
        usedAssets = Math.max(0, investable - finalLoan);
        if(investable === priceLimit) reason = 'ê°€ê²©í•œë„';
      }

      // í‘œì‹œìš© LTV í•œë„: ìµœì¢… íˆ¬ìê°€ëŠ¥ ê¸ˆì•¡ Ã— LTV%
      const ltvLimitForDisplay = (ltv > 0 && isFinite(investable))
        ? (ltv * investable)
        : Infinity;

      // ì›” ìƒí™˜/í‘œì‹œ ê³„ì‚°
      const moPay  = monthlyPayment(finalLoan, rate, months);
      const moPrin = finalLoan/months;
      const moInt  = moPay - moPrin;
      const avgMoIncome = income/12;
      const gap = avgMoIncome - moPay;
      const repayRatio = (moPay/avgMoIncome)*100;
      const leverageUtil = (finalLoan/investable)*100;

      // ê²½ê³ /ìê²©
      const eligDiv=document.getElementById('eligibility'); 
      eligDiv.classList.add('hide'); eligDiv.innerHTML='';
      const warns=[];
      if(incomeLimit<Infinity && income>incomeLimit){
        const txt = `${(domain==='bank')?'ì„œë¯¼Â·ì‹¤ìˆ˜ìš”ì':''} ì—°ì†Œë“ <b>${eok(incomeLimit)}ì–µì›</b> ì´í•˜ ìš”ê±´`;
        warns.push(`${txt} ì´ˆê³¼ (í˜„ì¬: <b>${eok(income)}ì–µì›</b>)`);
      }
      if(priceLimit<Infinity && (assets + finalLoan) > priceLimit){
        warns.push(`${(domain==='policy')?'ì •ì±…ì„± ìƒí’ˆ':'ì„œë¯¼Â·ì‹¤ìˆ˜ìš”ì'} ê°€ê²©í•œë„ <b>${eok(priceLimit)}ì–µì›</b> ì´ˆê³¼`);
      }
      const needEligibility = warns.length>0;
      if(needEligibility){
        eligDiv.classList.remove('hide');
        eligDiv.innerHTML=`<div class="error">âš ï¸ ìê²© í™•ì¸: <br>â€¢ ${warns.join('<br>â€¢ ')}</div>`;
      }

      // í™”ë©´ ì¶œë ¥
      const isCapitalBank=(domain==='bank' && isCapital);
      const stressLine = (dsr>0 && isCapitalBank) ? `<div class="pill">DSR ìŠ¤íŠ¸ë ˆìŠ¤ ê¸ˆë¦¬: ${(rate*100+3).toFixed(2)}% (ìˆ˜ë„ê¶Œ ìë™ +3%)</div>` : '';

      const appliedLtvPct = (ltv>0) ? (ltv*100).toFixed(0) : 'â€“';

      // ê°•ì¡° ì¹´ë“œ (ìê²©í™•ì¸ ë°°ì§€ í¬í•¨)
      const badge = needEligibility ? `<span class="elig-badge" role="note" aria-label="ìê²©í™•ì¸ í•„ìˆ˜">ìê²©í™•ì¸ í•„ìˆ˜</span>` : '';
      const investLine = `íˆ¬ìê°€ëŠ¥ ê¸ˆì•¡ëŒ€: ìì‚° ${formatAmount(Math.floor(usedAssets))} + ëŒ€ì¶œ ${eok(finalLoan)}ì–µì› = <span class="amount">${formatAmount(Math.floor(investable))}</span>${badge}`;
      const activeNote =
        (reason==='LTV')?'LTVê°€ ì œí•œ'
        :(reason==='DTI')?'DTIê°€ ì œí•œ'
        :(reason==='DSR')?'DSRì´ ì œí•œ'
        :(reason==='ê°€ê²©í•œë„')?'ê°€ê²©(ìƒí’ˆ) í•œë„ë¡œ ì œí•œ'
        :(reason==='ê°€ê²©êµ¬ê°„ ëŒ€ì¶œìº¡')?'ê°€ê²©êµ¬ê°„ë³„ ëŒ€ì¶œìº¡ìœ¼ë¡œ ì œí•œ'
        :(reason==='LTV(ê°€ê²©êµ¬ê°„ í›„)')?'LTV(ê°€ê²©êµ¬ê°„ ì ìš© í›„)ë¡œ ì œí•œ'
        :(reason==='ìƒí’ˆí•œë„')?'ìƒí’ˆí•œë„ë¡œ ì œí•œ'
        : 'ìµœì†Œ í•œë„ ì ìš©';

      const loanLine = `ğŸ’¡ ìµœì¢… ëŒ€ì¶œ í•œë„: <u>${eok(finalLoan)}ì–µì›</u> <span class="subtle">(${activeNote})</span>`;

      const finalBox =
        `<div class="highlight-card" role="status" aria-live="polite">
           <div class="highlight-primary">${investLine}</div>
           <div class="highlight-secondary">${loanLine}</div>
         </div>`;

      let limitHtml =
        `<strong>DTI í•œë„:</strong> ${eok(dtiLimit)}ì–µì› (DTI ${(dti*100).toFixed(0)}%)<br>`+
        `<strong>DSR í•œë„:</strong> ${dsr===0?'ë¹„ì ìš©':`${eok(dsrLimit)}ì–µì›`}${(dsr>0&&isCapitalBank)?` <span class="subtle">(ìŠ¤íŠ¸ë ˆìŠ¤ ë¯¸ì ìš©ì‹œ ${eok(dsrLimitNoStress)}ì–µì›)</span>`:''}<br>`+
        `<strong>LTV í•œë„:</strong> ${ltv===0?'ë¹„ì ìš©':`${eok(ltvLimitForDisplay)}ì–µì›`} <span class="subtle">(ì ìš© LTV: ${appliedLtvPct}%)</span><br>`;
      if(productCap<Infinity) limitHtml+=`<strong>ìƒí’ˆí•œë„:</strong> ${eok(productCap)}ì–µì›<br>`;

      document.getElementById('result').innerHTML =
        `${finalBox}` +
        `${limitHtml}${stressLine}<hr>`+
        (priceBandNote?`<div class="warn" style="margin:10px 0;">${priceBandNote}</div>`:'')+
        `<strong>ê³µì  ë ˆë²„ë¦¬ì§€ ì´ìš©ë¥ :</strong> ${isFinite(leverageUtil)?leverageUtil.toFixed(1):'â€“'}%<br><br>`+
        `<strong>ì›” ìƒí™˜ê¸ˆ(ì›ë¦¬ê¸ˆê· ë“±):</strong> ${Math.floor(moPay)}ë§Œì›<br>`+
        `- ì›” ì›ê¸ˆ: ${Math.floor(moPrin)}ë§Œì› / ì›” ì´ì: ${Math.floor(moInt)}ë§Œì›<br>`+
        `<hr><strong>ğŸ“Š ì›” ì†Œë“ ë¶„ì„</strong><br>`+
        `- í‰ê·  ì›”ê¸‰: ${Math.floor(avgMoIncome)}ë§Œì›<br>`+
        `- ì›” ìƒí™˜ í›„ ì”ì—¬: ${Math.floor(gap)}ë§Œì›<br>`+
        `- ìƒí™˜ ë¹„ìœ¨(DSR ê´€ì ): ${isFinite(repayRatio)?repayRatio.toFixed(1):'â€“'}%`;

      document.getElementById('result').classList.remove('hide');

      // ê³„ì‚° ê³¼ì •(ìš”ì•½)
      const steps=document.getElementById('calculationSteps');
      steps.innerHTML =
        `<h3>âœ… í•œë„ ë¹„êµÂ·ìµœì í™” ê³¼ì •</h3>
         <p><b>Step 1</b> ì†Œë“ê¸°ë°˜ í•œë„: DTI ${eok(dtiLimit)}ì–µ${dsr>0?`, DSR ${eok(dsrLimit)}ì–µ`:''}</p>
         <p><b>Step 2</b> LTV í•œë„(ì—­ì‚°): <b>${eok(ltvLimitNew)}ì–µ</b> <span class="subtle">(ì ìš© LTV: ${appliedLtvPct}%)</span></p>
         <p><b>Step 3</b> ì ˆëŒ€ìº¡ ìµœì†Œê°’ = <b>${eok(prelimLoan)}ì–µ (${minHard.t})</b>${isFinite(productCap)?` (ìƒí’ˆí•œë„ í¬í•¨)`:''}</p>
         ${domain==='bank' ? `
         <p><b>Step 4</b> ê°€ê²©êµ¬ê°„ ìµœì í™”: â‘ â‰¤15ì–µ â‰¤6ì–µ â‘¡15~25ì–µ â‰¤4ì–µ â‘¢>25ì–µ â‰¤2ì–µ â†’ íˆ¬ìê¸ˆ ìµœëŒ€ & ìì‚°íˆ¬ì… ìµœì†Œ</p>
         <p><b>Step 5</b> (ê°€ê²©êµ¬ê°„ ì œí•œ ì‹œ) ìµœì¢… íˆ¬ìê°€ëŠ¥ ê¸ˆì•¡ Ã— LTV%ë¡œ ëŒ€ì¶œ ìƒí•œ ì¬ì¡°ì •</p>` : `
         <p><b>Step 4</b> ì •ì±…ì„±: ìƒí’ˆìº¡/ê°€ê²©í•œë„ ë‚´ì—ì„œ ëŒ€ì¶œ ìµœëŒ€Â·ìì‚° ìµœì†Œ</p>`}
         <p><b>Result</b> ëŒ€ì¶œ ${eok(finalLoan)}ì–µ / ìì‚° ${eok(usedAssets)}ì–µ â†’ íˆ¬ì ${eok(investable)}ì–µ</p>`;
      steps.classList.remove('hide');

      // ìŠ¤í¬ë¡¤ íŒíŠ¸ ì¬í‰ê°€
      requestAnimationFrame(()=>{
        updateSectionFades();
        updateBottomHint();
      });
    }

    /* âœ… ì„¹ì…˜/í•˜ë‹¨ ìŠ¤í¬ë¡¤ íŒíŠ¸ ë¡œì§ */
    function updateSectionFades(){
      const boxes = document.querySelectorAll('.box');
      const vh = window.innerHeight || document.documentElement.clientHeight;

      boxes.forEach((box, idx)=>{
        const fade = box.querySelector('.section-fade');
        if(!fade) return;

        // ë³´ì´ëŠ”ì§€/ëì— ê°€ê¹Œìš´ì§€ íŒë‹¨
        const r = box.getBoundingClientRect();
        const inView = r.top < vh && r.bottom > 80;       // ì¼ë¶€ë¼ë„ í™”ë©´ê³¼ ê²¹ì¹¨
        const hasMoreBelow = r.bottom > (vh + 16);        // í™”ë©´ ì•„ë˜ë¡œ ë” ë‚´ìš©ì´ ë‚¨ìŒ
        const notLast = idx !== (boxes.length - 1);       // ë§ˆì§€ë§‰ ë°•ìŠ¤ëŠ” ëœ í‘œì‹œ

        // ë„ˆë¬´ ì‘ì€ ì„¹ì…˜ì€ ìˆ¨ê¹€
        const tallEnough = (r.height || 0) > 120;

        const show = inView && hasMoreBelow && tallEnough && notLast;
        fade.classList.toggle('show', show);
      });
    }

    function updateBottomHint(){
      const hint = document.querySelector('.scroll-hint');
      if(!hint) return;
      const THRESHOLD = 120; // ë°”ë‹¥ ê·¼ì²˜ ì—¬ìœ (px)
      const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - THRESHOLD);
      hint.classList.toggle('hide', nearBottom);
    }

    // ì´ë²¤íŠ¸ ì—°ê²°
    window.addEventListener('scroll', ()=>{
      updateSectionFades();
      updateBottomHint();
    }, {passive:true});
    window.addEventListener('resize', ()=>{
      updateSectionFades();
      updateBottomHint();
    });

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', ()=>{
      switchDomain();  // íŒ¨ë„ í‘œì‹œìƒíƒœ ì •ë¦¬
      updateSectionFades();
      updateBottomHint();
      // ì•½ê°„ ì§€ì—° í›„ í•œ ë²ˆ ë” (í° ê°€ìƒ í‚¤ë³´ë“œ/í°íŠ¸ ë¡œë”© ëŒ€ì‘)
      setTimeout(()=>{ updateSectionFades(); updateBottomHint(); }, 80);
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title> LTV + 급여 투자맵</title>
<style>
  :root{--fg:#222;--bg:#f9f9f9;--card:#fff;--accent:#4CAF50;--muted:#666;}
  *{box-sizing:border-box}
  body{
    font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
    max-width: 900px; width: 94%; margin: 24px auto; padding: 0;
    color:var(--fg); background:var(--bg);
  }
  h1{font-size:1.35rem; margin:0 0 14px; text-align:center}
  .grid{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; margin-top:8px}
  .grid .wide{grid-column: span 3}
  label{font-weight:600; font-size:0.95rem}
  input[type="number"]{
    width:100%; padding:12px; font-size:1rem; border:1px solid #ddd; border-radius:10px; background:#fff;
  }
  .card{
    background:var(--card); border-radius:14px; padding:16px; box-shadow:0 1px 6px rgba(0,0,0,.06);
    margin-top:14px;
  }
  .hint{font-size:0.85rem; color:var(--muted)}
  .pill{
    display:inline-block; padding:6px 10px; border-radius:999px; background:#eef7ee; color:#1e6e26; font-weight:700; font-size:0.92rem
  }
  .primary-btn{
    background:var(--accent); color:#fff; border:none; border-radius:12px; padding:12px 16px; font-weight:700;
    cursor:pointer; width:100%;
  }
  .primary-btn:hover{filter:brightness(.95)}
  table{width:100%; border-collapse:collapse; margin-top:10px; font-size:0.95rem}
  thead th{
    position:sticky; top:0; background:#f0f0f0; z-index:1;
    padding:10px 8px; border-bottom:2px solid #ddd; text-align:center
  }
  tbody td{padding:9px 8px; border-bottom:1px solid #eee; text-align:right}
  tbody td:first-child{font-weight:700; text-align:center}
  /* LTV·전세 영역 구분선 */
  .sep{border-right:2px solid #bbb !important}
  /* 조건부 색상 */
  .invest-ok{background:#eaf4ff}   /* 투자 가능(≥) → 연한 파란색 */
  .invest-low{background:#fff2e0}  /* 투자 부족(<) → 연한 주황색 */
  .footer{margin:18px 0 28px; text-align:center; font-size:0.9rem; color:var(--muted)}
  .row{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:6px}
  .dsr-box{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
  .dsr-val{font-size:1.05rem; font-weight:800}
  .note{font-size:0.85rem; color:#444; background:#f6f6ff; padding:8px 10px; border-radius:10px; margin-top:8px}
</style>
</head>
<body>
  <h1>수도권 DSR 40% 한도 & LTV/전세 표</h1>

  <!-- 입력 카드 -->
  <div class="card">
    <div class="grid">
      <div>
        <label>연봉 (만원)</label>
        <input id="income" type="number" placeholder="예: 6,000" oninput="renderAll()" />
        <div class="hint">세전 연소득 기준, 기타부채 없음 가정</div>
      </div>
      <div>
        <label>대출 금리 (연 %)</label>
        <input id="rate" type="number" step="0.01" value="4.5" oninput="renderAll()"/>
        <div class="hint">원리금균등 상환 가정</div>
      </div>
      <div>
        <label>상환 기간 (년)</label>
        <input id="years" type="number" value="30" oninput="renderAll()"/>
        <div class="hint">예: 30</div>
      </div>

      <div>
        <label>투자금액 (억)</label>
        <input id="investEok" type="number" step="0.1" value="0" oninput="renderAll()"/>
        <div class="hint">자기자본(현금·보증금 등) 총액</div>
      </div>
      <div>
        <label>표 최소 (억)</label>
        <input id="minEok" type="number" value="6" oninput="renderAll()"/>
      </div>
      <div>
        <label>표 최대 (억)</label>
        <input id="maxEok" type="number" value="20" oninput="renderAll()"/>
      </div>
      <div>
        <label>표 간격 (억)</label>
        <input id="stepEok" type="number" value="1" oninput="renderAll()"/>
      </div>

      <!-- ✅ 전세가율 간격 입력 추가 -->
      <div class="wide">
        <label>전세가율 간격 (%)</label>
        <input id="jeonseStepPct" type="number" min="1" max="30" step="1" value="10" oninput="renderAll()"/>
        <div class="hint">70%부터 40%까지, 간격만 조정합니다. 예: 5 → 70, 65, 60, 55, 50, 45, 40</div>
      </div>
    </div>

    <div style="margin-top:12px">
      <button class="primary-btn" onclick="renderAll()">계산하기</button>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="dsr-box">
        <div><span class="pill">DSR 40%</span></div>
        <div class="dsr-val" id="dsrLimitDisplay">—</div>
      </div>
      <div class="note">
        색상/투자판정 기준(LTV 열): <b>min(DSR 한도, LTV 계산액, 6억)</b>을 사용해 필요한 자기자본을 산출합니다.<br/>
        표시는 LTV 값을 <b>6억 상한</b>으로 캡 해 표기합니다.
      </div>
    </div>
  </div>

  <!-- 결과 표 카드 -->
  <div class="card" id="tableCard">
    <div class="row" style="margin-bottom:6px">
      <div><strong>단지가격별 LTV/전세가율 표</strong></div>
      <div class="hint">단위: 억원</div>
    </div>
    <div style="max-height: 60vh; overflow:auto; border:1px solid #eee; border-radius:10px">
      <table id="resultTable">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    계산 가정: 원리금균등, 기타부채·보험료 등 DSR 공제 없음. LTV 표시는 가격×LTV 후 <b>6억 상한</b> 적용, 색상 판정은 <b>min(DSR, LTV, 6억)</b>.
  </div>

<script>
  // 포맷터
  const toEok = (manwon) => manwon / 10000;
  const fmtEok = (eok) => isFinite(eok) ? eok.toLocaleString('ko-KR',{minimumFractionDigits:2, maximumFractionDigits:2}) + '억' : '—';

  // DSR 40% 한도 (원리금균등)
  function calcDSRLimitManwon(incomeManwon, annualRatePct, years){
    if(!incomeManwon || !annualRatePct || !years) return 0;
    const monthlyPay = (incomeManwon * 0.40) / 12; // 만원
    const r = (annualRatePct/100) / 12;
    const n = years * 12;
    if(r === 0) return monthlyPay * n; // 금리 0% 안전처리
    return monthlyPay * (1 - Math.pow(1+r, -n)) / r; // 만원
  }

  // ✅ 70% → 40%까지 전세가율을 간격(step%)로 생성
  function buildJeonseRates(stepPct){
    let step = Number(stepPct);
    if(!isFinite(step) || step <= 0) step = 10;
    if(step > 30) step = 30; // 안전상한
    const rates = [];
    for(let p = 70; p >= 40 - 1e-9; p -= step){
      // 40% 아래로 내려가면 강제로 40%를 마지막에 포함
      if(p < 40 && rates[rates.length-1] !== 40) { rates.push(40); break; }
      rates.push(Math.round(p * 100) / 100); // 소수 입력 대비 반올림
      if(p === 40) break;
    }
    // 중복/정렬 보정
    const uniq = [...new Set(rates.map(v=>Math.max(40, Math.min(70, v))))];
    uniq.sort((a,b)=>b-a);
    if(uniq[uniq.length-1] !== 40) uniq.push(40);
    return uniq.map(v=>v/100); // 소수(0.7, 0.65...)로 반환
  }

  // ✅ 동적 테이블 헤더 구성
  function renderHeader(jeonseRates){
    const thead = document.getElementById('thead');
    thead.innerHTML = '';

    const tr1 = document.createElement('tr');
    const thPrice = document.createElement('th');
    thPrice.rowSpan = 2; thPrice.textContent = '가격';
    tr1.appendChild(thPrice);

    const thLtvGrp = document.createElement('th');
    thLtvGrp.colSpan = 3; thLtvGrp.classList.add('sep');
    thLtvGrp.textContent = '대출액 (LTV, 6억 상한 표기)';
    tr1.appendChild(thLtvGrp);

    const thJeonseGrp = document.createElement('th');
    thJeonseGrp.colSpan = jeonseRates.length;
    thJeonseGrp.textContent = '전세금 (전세가율)';
    tr1.appendChild(thJeonseGrp);

    const tr2 = document.createElement('tr');
    ['70%','50%','40%'].forEach((txt, idx)=>{
      const th = document.createElement('th');
      th.textContent = txt;
      if(idx === 2) th.classList.add('sep');
      tr2.appendChild(th);
    });

    jeonseRates.forEach(r=>{
      const th = document.createElement('th');
      th.textContent = Math.round(r*100) + '%';
      tr2.appendChild(th);
    });

    thead.appendChild(tr1);
    thead.appendChild(tr2);
  }

  function buildTable(minEok, maxEok, stepEok, investEok, dsrLimitEok, jeonseRates){
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    const ltvRates = [0.70, 0.50, 0.40];

    // 보정
    if(maxEok < minEok){ const t=minEok; minEok=maxEok; maxEok=t; }
    if(stepEok <= 0) stepEok = 1;

    for(let priceEok = minEok; priceEok <= maxEok + 1e-9; priceEok += stepEok){
      const tr = document.createElement('tr');

      // 가격
      const tdPrice = document.createElement('td');
      tdPrice.textContent = fmtEok(priceEok);
      tr.appendChild(tdPrice);

      // LTV 대출액 (표시는 6억 캡, 색상판정은 min(DSR, LTV, 6))
      ltvRates.forEach((r, idx)=>{
        const rawLoanEok = priceEok * r;                // LTV 계산액(억)
        const ltvCappedEok = Math.min(rawLoanEok, 6);   // 표기용 6억 상한
        const dsrCap = (dsrLimitEok > 0) ? dsrLimitEok : Infinity;
        const effectiveLoanEok = Math.min(rawLoanEok, 6, dsrCap); // ✅ 판정용 커트라인

        const needEquityEok = priceEok - effectiveLoanEok; // 필요 자기자본(판정기준)
        const td = document.createElement('td');

        // 색상판정
        if(investEok >= needEquityEok) td.classList.add('invest-ok');
        else td.classList.add('invest-low');

        if(idx === 2) td.classList.add('sep'); // LTV/전세 구분선
        td.textContent = fmtEok(ltvCappedEok); // 표시는 6억 상한
        td.title = `근거: min(DSR:${fmtEok(dsrCap===Infinity?NaN:dsrCap)}, LTV:${fmtEok(rawLoanEok)}, 6억) = ${fmtEok(effectiveLoanEok)}
필요자본: ${fmtEok(needEquityEok)} / 보유: ${fmtEok(investEok)}`;
        tr.appendChild(td);
      });

      // 전세가율 (DSR 미적용: 갭=가격−전세금 기준)
      jeonseRates.forEach(r=>{
        const jeonseEok = priceEok * r;           // 전세금(억)
        const gapEok = priceEok - jeonseEok;      // 필요자본(갭)
        const td = document.createElement('td');
        if(investEok >= gapEok) td.classList.add('invest-ok');
        else td.classList.add('invest-low');
        td.textContent = fmtEok(jeonseEok);
        td.title = `필요자본(갭): ${fmtEok(gapEok)} / 보유: ${fmtEok(investEok)}`;
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    }
  }

  function renderAll(){
    const income = parseFloat(document.getElementById('income').value);
    const rate   = parseFloat(document.getElementById('rate').value);
    const years  = parseFloat(document.getElementById('years').value);

    const investEok = parseFloat(document.getElementById('investEok').value) || 0;
    const minEok = parseFloat(document.getElementById('minEok').value) || 6;
    const maxEok = parseFloat(document.getElementById('maxEok').value) || 20;
    const stepEok = parseFloat(document.getElementById('stepEok').value) || 1;

    const jeonseStepPct = parseFloat(document.getElementById('jeonseStepPct').value) || 10;
    const jeonseRates = buildJeonseRates(jeonseStepPct); // ✅ 동적 생성 (0.70→0.40)

    // DSR 한도 (만원 -> 억)
    const dsrLimitManwon = calcDSRLimitManwon(income, rate, years);
    const dsrLimitEok = toEok(dsrLimitManwon);
    document.getElementById('dsrLimitDisplay').textContent =
      dsrLimitManwon > 0 ? `${fmtEok(dsrLimitEok)} (연 ${isFinite(rate)?rate.toFixed(2):'-'}%, ${years||'-'}년)` : '연봉·금리·기간을 입력하세요';

    // 헤더 & 표 렌더
    renderHeader(jeonseRates);
    buildTable(minEok, maxEok, stepEok, investEok, dsrLimitEok, jeonseRates);
  }

  // 초기 렌더
  renderAll();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ë¶€íƒœë¦¬ì˜ ë¶€ë™ì‚° ëŒ€ì¶œê³„ì‚°ê¸°</title>
<style>
  :root{
    --bg:#f9f9f9; --card:#fff; --bd:#e5e7eb; --fg:#111; --sub:#555;
    --pill-bg:#f1f5f9; --pill-bd:#e5e7eb;
    --ok-bg:#ecfdf5; --ok-bd:#a7f3d0; --ok-fg:#065f46;
    --warn-bg:#fff7ed; --warn-bd:#fde68a; --warn-fg:#b45309;
    --err-bg:#fef2f2; --err-bd:#fecaca; --err-fg:#991b1b;
  }

  /* ìŠ¤í¬ë¡¤ UX */
  html{ scroll-behavior:smooth; }
  body{ overscroll-behavior-y:contain; -webkit-overflow-scrolling:touch; }

  /* ê¸°ë³¸ íƒ€ì´í¬ & ë ˆì´ì•„ì›ƒ */
  *{box-sizing:border-box}
  html,body{height:100%}
  body {
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif;
    color: var(--fg);
    background: var(--bg);
    max-width: 720px;
    width: 92%;
    margin: 0 auto;
    padding: 22px;              /* ì—¬ë°± ì‚´ì§ ì¦ê°€ */
    line-height: 1.55;
    word-break: keep-all;
  }
  h2 {
    text-align: center;
    margin: 8px 0 18px;
    font-size: clamp(1.1rem, 2.8vw, 1.4rem);
  }
  label { font-weight: 700; margin-top: 10px; display: block; }
  input, select, button {
    width: 100%; padding: 12px; margin-bottom: 12px; font-size: 1rem; border-radius: 10px;
    border:1px solid var(--bd); background:#fff; outline:none;
  }
  input:focus, select:focus, button:focus { box-shadow: 0 0 0 3px rgba(59,130,246,.18); }
  input[type="checkbox"], input[type="radio"] { width: auto; margin-right: 8px; }
  .checkbox-label { display: flex; align-items: center; gap:8px; margin: 6px 0; font-size: 0.98rem; flex-wrap: wrap; }

  .row { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
  .row-1 { display: grid; grid-template-columns: 1fr; gap: 10px; }

  .box {
    background: var(--card);
    border: 1px solid var(--bd);
    border-radius: 12px;
    padding: 16px;              /* ë‚´ë¶€ ì—¬ë°± ì¦ê°€ */
    margin: 14px 0 16px;        /* ì„¹ì…˜ ê°„ê²© ì¦ê°€ â†’ ìŠ¤í¬ë¡¤ ìœ ë„ */
    scroll-margin-top: 14px;    /* ì•µì»¤ ì´ë™ ì‹œ ìƒë‹¨ ì—¬ë°± */
  }
  .result {
    background: var(--card);
    border: 1px solid var(--bd);
    border-radius: 12px;
    padding: 16px;
    margin-top: 16px;
    font-size: clamp(0.92rem, 2.6vw, 0.98rem);
    line-height: 1.65;
    overflow-wrap: anywhere;
  }

  .subtle { font-size: 0.9rem; color: var(--sub); }
  .hint { font-size: 0.86rem; color:#666; }
  .hangul { font-size: 0.9rem; color:#555; display:block; margin-top:-6px; margin-bottom:8px; }
  .section-title { font-weight: 800; margin: 4px 0 10px; font-size: 1.05rem; }

  .caps { display:flex; align-items:center; gap:6px; flex-wrap: wrap; padding-top: 4px; }
  .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:var(--pill-bg); border:1px solid var(--pill-bd); font-size:12px; margin:2px 4px 2px 0; white-space: nowrap; }

  .ok { color:var(--ok-fg); background:var(--ok-bg); border:1px solid var(--ok-bd); padding:10px; border-radius:8px; }
  .warn { color:var(--warn-fg); background:var(--warn-bg); border:1px solid var(--warn-bd); padding:10px; border-radius:8px; }
  .error{ color:var(--err-fg); background:var(--err-bg); border:1px solid var(--err-bd); padding:10px; border-radius:8px; }

  .hide { display:none; }
  .centered { text-align:center; }

  /* íˆ´íŒ (ëª¨ë°”ì¼ ë„˜ì¹¨ ë°©ì§€) */
  .tip-wrap{
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding-bottom: 8px;
  }
  .tip-trigger{ display:inline-flex; align-items:center; gap:6px; cursor:help; }
  .tip-trigger .text{ border-bottom: 1px dotted #94a3b8; }
  .tip-icon{
    width:20px; height:20px; line-height:20px; text-align:center; font-size:12px; flex:0 0 auto;
    border-radius:999px; border:1px solid #cbd5e1; background:#f8fafc; color:#334155;
    cursor:pointer; user-select:none;
  }
  .tip-box{
    position:absolute; left:0; top:calc(100% + 6px);
    z-index:30; min-width: 240px; max-width: min(86vw, 360px);
    background:#111827; color:#f9fafb; border:1px solid #374151; border-radius:10px;
    padding:12px; font-size:0.9rem; box-shadow:0 12px 24px rgba(0,0,0,0.18);
    opacity:0; visibility:hidden; pointer-events:none; transition:opacity .12s ease;
    white-space:normal; overflow-wrap:anywhere;
  }
  .tip-box b{ color:#bfdbfe; }
  .tip-box ul{ margin:6px 0 0 16px; padding:0; }
  .tip-box li{ margin:2px 0; }

  .tip-wrap:hover .tip-box,
  .tip-wrap:focus-within .tip-box,
  .tip-wrap.open .tip-box{
    opacity:1; visibility:visible; pointer-events:auto;
  }

  /* ëª¨ë°”ì¼ ìµœì í™” */
  @media (max-width: 640px){
    body{ padding: 18px; }
    .row{ grid-template-columns: 1fr; gap: 8px; }
    input, select, button{ padding: 14px; font-size: 1.02rem; }
    .pill{ white-space: initial; }
    .tip-box{ left: 0; right: 0; margin-inline: 0; }
  }
  @media (max-width: 360px){
    body{ font-size: 1.02rem; }
    .result{ font-size: 1rem; }
  }

  /* ê¸°ë³¸ ë²„íŠ¼(ë¹„-sticky) */
  .btn-primary{
    background:#0ea5e9; color:#fff; border: none; font-weight: 800; letter-spacing:.2px;
    padding: 14px 16px; border-radius: 12px; cursor: pointer; margin-top: 4px;
  }
  .btn-primary:active{ transform: translateY(1px); }
</style>
</head>
<body>
<h2>ë¶€íƒœë¦¬ì˜ ëŒ€ì¶œê³„ì‚°ê¸°</h2>

<div class="box">
  <div class="section-title">â‘  ê¸°ë³¸ ì…ë ¥</div>

  <label>ì—°ë´‰ (ë§Œì›)</label>
  <input id="income" type="number" inputmode="numeric" oninput="updateHangulAmount('income')"/>
  <span id="incomeText" class="hangul"></span>

  <!-- ê°€ê²© ì…ë ¥ê³¼ í•œë„ ìš”ì•½: ì„¸ë¡œ ë°°ì¹˜ -->
  <div class="row-1">
    <div>
      <label>ë¶€ë™ì‚° ê°€ê²© (ë§Œì›)</label>
      <input id="propertyPrice" type="number" inputmode="numeric" oninput="updateHangulAmount('propertyPrice')"/>
      <span id="propertyPriceText" class="hangul"></span>
    </div>
    <div>
      <label class="subtle">í•œë„ ìš”ì•½</label>
      <div id="priceCaps" class="caps"></div>
    </div>
  </div>

  <div class="row">
    <div>
      <label>ëŒ€ì¶œ ê¸ˆë¦¬ (ì—° %, ì†Œìˆ˜ì  ê°€ëŠ¥)</label>
      <input id="interestRate" type="number" step="0.01" inputmode="decimal"/>
    </div>
    <div>
      <label>ìƒí™˜ ê¸°ê°„ (ë…„)</label>
      <input id="loanTerm" type="number" inputmode="numeric"/>
    </div>
  </div>

  <label>ê¸°ì¡´ ëŒ€ì¶œ ì›” ìƒí™˜ê¸ˆ (ë§Œì›)</label>
  <input id="existingLoanMonthly" type="number" value="0" inputmode="numeric"/>
</div>

<div class="box">
  <div class="section-title">â‘¡ ëŒ€ì¶œ ì¢…ë¥˜ ì„ íƒ</div>
  <label class="checkbox-label"><input type="radio" name="loanDomain" value="bank" checked onclick="switchDomain()" /> ê¸ˆìœµê¶Œ ëŒ€ì¶œ</label>
  <label class="checkbox-label"><input type="radio" name="loanDomain" value="policy" onclick="switchDomain()" /> ì •ì±…ì„± ëŒ€ì¶œ(ë””ë”¤ëŒ/ë³´ê¸ˆìë¦¬ë¡ )</label>
</div>

<!-- ê¸ˆìœµê¶Œ ì˜µì…˜ -->
<div id="bankPanel" class="box">
  <div class="section-title">ê¸ˆìœµê¶Œ ì„¸ë¶€ ì„ íƒ</div>
  <label class="checkbox-label"><input type="radio" name="bankBorrower" value="general" checked onclick="applyBankPreset()" /> ì¼ë°˜ì°¨ì£¼</label>
  <label class="checkbox-label"><input type="radio" name="bankBorrower" value="first" onclick="applyBankPreset()" /> ìƒì• ìµœì´ˆ</label>
  <label class="checkbox-label"><input type="radio" name="bankBorrower" value="seomin" onclick="applyBankPreset()" /> ì„œë¯¼Â·ì‹¤ìˆ˜ìš”ì <span class="hint">ì—°ì†Œë“ 9ì²œâ†“, ì£¼íƒê°€ê²© 8ì–µâ†“, ë¬´ì£¼íƒ</span></label>

  <div class="row-1">
    <div>
      <label>ê¸ˆìœµê¶Œ êµ¬ë¶„</label>
      <select id="bankTier" onchange="applyBankPreset()">
        <option value="tier1">1ê¸ˆìœµê¶Œ (DSR 40%)</option>
        <option value="tier2">2ê¸ˆìœµê¶Œ (DSR 50%)</option>
      </select>
    </div>
  </div>

  <div class="row" style="margin-top:4px;">
    <label class="checkbox-label" style="margin-bottom:0;">
      <input type="checkbox" id="speculativeArea" onchange="applyBankPreset()"/>
      <span class="tip-wrap" id="tipSpecWrap">
        <span class="tip-trigger" aria-describedby="tip-spec">
          <span class="text">íˆ¬ê¸°ê³¼ì—´ì§€êµ¬</span>
          <span class="tip-icon" id="tipBtn" role="button" tabindex="0" aria-label="íˆ¬ê¸°ê³¼ì—´ì§€êµ¬ ì•ˆë‚´">â„¹ï¸</span>
        </span>
        <div class="tip-box" id="tip-spec" role="tooltip" aria-live="polite">
          <div><b>íˆ¬ê¸°ê³¼ì—´ì§€êµ¬ ì§€ì •(ìš”ì•½)</b></div>
          <div>âœ“ (ì„œìš¸) 25ê°œêµ¬ ì „ì—­</div>
          <div>âœ“ (ê²½ê¸°) 12ê°œ ì§€ì—­</div>
          <ul>
            <li>ê³¼ì²œì‹œ, ê´‘ëª…ì‹œ</li>
            <li>ìˆ˜ì›ì‹œ ì˜í†µêµ¬Â·ì¥ì•ˆêµ¬Â·íŒ”ë‹¬êµ¬</li>
            <li>ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬Â·ìˆ˜ì •êµ¬Â·ì¤‘ì›êµ¬</li>
            <li>ì•ˆì–‘ì‹œ ë™ì•ˆêµ¬, ìš©ì¸ì‹œ ìˆ˜ì§€êµ¬</li>
            <li>ì˜ì™•ì‹œ, í•˜ë‚¨ì‹œ</li>
          </ul>
        </div>
      </span>
    </label>

    <label class="checkbox-label" style="margin-bottom:0;">
      <input type="checkbox" id="capitalArea" onchange="applyBankPreset()"/> ìˆ˜ë„ê¶Œ ì—¬ë¶€
      <span class="hint">ì²´í¬ ì‹œ DSR ìŠ¤íŠ¸ë ˆìŠ¤ +3%</span>
    </label>
  </div>

  <div id="stressAutoInfo" class="ok hide" style="margin:8px 0;">ìˆ˜ë„ê¶Œìœ¼ë¡œ íŒë‹¨ë˜ì–´ DSR ìŠ¤íŠ¸ë ˆìŠ¤ ê¸ˆë¦¬ <b>+3%</b>ê°€ ìë™ ì ìš©ë©ë‹ˆë‹¤.</div>
</div>

<!-- ì •ì±…ì„± ì˜µì…˜ -->
<div id="policyPanel" class="box hide">
  <div class="section-title">ì •ì±…ì„± ëŒ€ì¶œ ì„ íƒ</div>
  <label class="checkbox-label"><input type="radio" name="policyType" value="didim" checked onclick="switchPolicy()"/> ë””ë”¤ëŒ ëŒ€ì¶œ</label>
  <label class="checkbox-label"><input type="radio" name="policyType" value="bogum" onclick="switchPolicy()"/> ë³´ê¸ˆìë¦¬ë¡ </label>

  <div id="didimPanel" class="box">
    <div class="section-title">ë””ë”¤ëŒ ì„¸ë¶€</div>
    <label class="checkbox-label"><input type="radio" name="didimKind" value="normal" checked onclick="updatePriceCaps()"/> ì¼ë°˜(ê°€ê²© â‰¤ 5ì–µ, í•œë„ ìµœëŒ€ 2ì–µ)</label>
    <label class="checkbox-label"><input type="radio" name="didimKind" value="first" onclick="updatePriceCaps()"/> ìƒì• ìµœì´ˆ(ê°€ê²© â‰¤ 5ì–µ, í•œë„ ìµœëŒ€ 2.4ì–µ)</label>
    <label class="checkbox-label"><input type="radio" name="didimKind" value="newlyweds" onclick="updatePriceCaps()"/> ì‹ í˜¼Â·2ìë…€(ê°€ê²© â‰¤ <b>6ì–µ</b>, í•œë„ ìµœëŒ€ 3.2ì–µ)</label>
    <label class="checkbox-label"><input type="radio" name="didimKind" value="newborn" onclick="updatePriceCaps()"/> ì‹ ìƒì•„(ê°€ê²© â‰¤ 5ì–µ, í•œë„ ìµœëŒ€ 4ì–µ)</label>

    <div class="row">
      <div>
        <label>ë¶€ë¶€í•©ì‚° ì—°ì†Œë“ (ë§Œì›)</label>
        <input id="didimIncome" type="number" placeholder="ì˜ˆ: 6000" inputmode="numeric"/>
      </div>
      <div>
        <label>í•©ì‚° ìˆœìì‚° ê°€ì•¡ (ë§Œì›)</label>
        <input id="didimAsset" type="number" placeholder="ì˜ˆ: 48800" inputmode="numeric"/>
      </div>
    </div>
    <label class="checkbox-label"><input type="checkbox" id="didimNoHouse"/> ë¬´ì£¼íƒ ì„¸ëŒ€ì£¼</label>
    <div class="subtle">ìê²© í•µì‹¬: ê°€ê²© â‰¤5ì–µ(ì‹ í˜¼Â·2ìë…€ â‰¤6ì–µ), ì†Œë“ í•œë„, ìˆœìì‚° â‰¤4.88ì–µ</div>
  </div>

  <div id="bogumPanel" class="box hide">
    <div class="section-title">ë³´ê¸ˆìë¦¬ë¡  ì„¸ë¶€</div>
    <label class="checkbox-label"><input type="radio" name="bogumKind" value="normal" checked onclick="updatePriceCaps()"/> ì¼ë°˜(ê°€ê²© â‰¤ 6ì–µ, í•œë„ ìµœëŒ€ 3.6ì–µ)</label>
    <label class="checkbox-label"><input type="radio" name="bogumKind" value="first" onclick="updatePriceCaps()"/> ìƒì• ìµœì´ˆ(ê°€ê²© â‰¤ 6ì–µ, í•œë„ ìµœëŒ€ 4.2ì–µ)</label>
    <div class="row">
      <div>
        <label>ë¶€ë¶€í•©ì‚° ì—°ì†Œë“ (ë§Œì›)</label>
        <input id="bogumIncome" type="number" placeholder="ì˜ˆ: 7000" inputmode="numeric"/>
      </div>
      <div>
        <label>ë¹„(é)ì•„íŒŒíŠ¸ ì—¬ë¶€</label>
        <select id="bogumNonApt" onchange="switchPolicy()">
          <option value="no" selected>ì•„íŒŒíŠ¸(ìµœëŒ€ LTV 60%)</option>
          <option value="yes">ë¹„ì•„íŒŒíŠ¸(ìµœëŒ€ LTV 55%)</option>
        </select>
      </div>
    </div>
    <label class="checkbox-label"><input type="checkbox" id="bogumNoHouse"/> ë¬´ì£¼íƒ ë˜ëŠ” 1ì£¼íƒ(ìš”ê±´)</label>
    <div class="subtle">ìê²© í•µì‹¬: ê°€ê²© â‰¤6ì–µ, ì†Œë“ â‰¤7ì²œ, LTV 60%(ë¹„ì•„íŒŒíŠ¸ 55%), DTI 50%, DSR ì—†ìŒ</div>
  </div>
</div>

<div class="box">
  <div class="section-title">â‘¢ ìƒí™˜ ë°©ì‹</div>
  <label class="checkbox-label"><input type="radio" name="repaymentType" value="equalPrincipalInterest" checked/> ì›ë¦¬ê¸ˆ ê· ë“±</label>
  <label class="checkbox-label"><input type="radio" name="repaymentType" value="equalPrincipal"/> ì›ê¸ˆ ê· ë“±</label>
</div>

<div class="box">
  <div class="section-title">â‘£ ìˆ˜ë™ ë¹„ìœ¨ ì¡°ì • (ìë™ê°’ì„ ê¸°ë³¸ ì„¸íŒ…, í•„ìš” ì‹œ ìˆ˜ì •)</div>
  <div class="row">
    <div><label>LTV ë¹„ìœ¨ (%)</label><input id="ltvInput" type="number" step="0.1" value="70" inputmode="decimal"/></div>
    <div><label>DTI ë¹„ìœ¨ (%)</label><input id="dtiInput" type="number" step="0.1" value="60" inputmode="decimal"/></div>
  </div>
  <div class="row">
    <div><label>DSR ë¹„ìœ¨ (%)</label><input id="dsrInput" type="number" step="0.1" value="40" inputmode="decimal"/></div>
    <div><label>ì¶œì²˜/ë©”ëª¨</label><input id="sourceNote" type="text" placeholder="ì •ì±… ì¶œì²˜/ë©”ëª¨ ì…ë ¥(ì„ íƒ)"/></div>
  </div>
  <div class="subtle">â€» â€˜ìˆ˜ë„ê¶Œ ì—¬ë¶€â€™ ì²´í¬ ì‹œ <b>DSR ìŠ¤íŠ¸ë ˆìŠ¤ ê¸ˆë¦¬ +3%</b> ìë™ ë°˜ì˜.</div>
</div>

<!-- âœ… ì¼ë°˜ íë¦„ ë²„íŠ¼ (sticky ì œê±°) -->
<button class="btn-primary" onclick="calculateLoan()">ê³„ì‚°í•˜ê¸°</button>

<div id="eligibility" class="result hide"></div>
<div id="result" class="result"></div>

<footer class="centered" style="margin:18px 0 8px">
  <p>í˜‘ì—… ë° ìˆ˜ì • ë¬¸ì˜</p>
  <p><a href="https://litt.ly/richdadtechtree" target="_blank" rel="noopener">https://litt.ly/richdadtechtree</a></p>
</footer>

<script>
  /* ---------- í•œê¸€ ê¸ˆì•¡ í‘œê¸° ---------- */
  function numberToKorean(num) {
    const units = ["", "ë§Œ", "ì–µ", "ì¡°", "ê²½"];
    const digits = ["", "ì¼", "ì´", "ì‚¼", "ì‚¬", "ì˜¤", "ìœ¡", "ì¹ ", "íŒ”", "êµ¬"];
    const smallUnits = ["", "ì‹­", "ë°±", "ì²œ"];
    num = num * 10000;
    if (!num || num === 0) return "ì˜";
    const splitUnits = [];
    while (num > 0) { splitUnits.push(num % 10000); num = Math.floor(num / 10000); }
    const result = splitUnits.map((chunk, idx) => {
      if (chunk === 0) return '';
      let chunkStr = '';
      const str = chunk.toString().padStart(4, '0');
      const nums = str.split('').map(Number);
      nums.forEach((n, i) => {
        if (n === 0) return;
        const unit = smallUnits[3 - i];
        if (n === 1 && unit !== '') chunkStr += unit;
        else chunkStr += digits[n] + unit;
      });
      return chunkStr + units[idx];
    });
    return result.reverse().join('');
  }
  function updateHangulAmount(fieldId) {
    const v = parseInt(document.getElementById(fieldId).value);
    document.getElementById(fieldId + 'Text').innerText = isNaN(v) ? '' : 'â†’ ' + numberToKorean(v) + 'ì›';
  }

  /* === ì •ì±…ì„± ëŒ€ì¶œ: ì—°ë´‰ â†’ ë¶€ë¶€í•©ì‚° ì—°ì†Œë“ ìë™ ë™ê¸°í™” === */
  let didimIncomeEdited = false;
  let bogumIncomeEdited = false;

  function syncPolicyIncome(force = false) {
    const domain = document.querySelector('input[name="loanDomain"]:checked')?.value;
    if (domain !== 'policy') return;

    const incomeVal = document.getElementById('income')?.value ?? '';
    const didimEl = document.getElementById('didimIncome');
    const bogumEl = document.getElementById('bogumIncome');

    if (didimEl) { if (force || !didimIncomeEdited) didimEl.value = incomeVal; }
    if (bogumEl) { if (force || !bogumIncomeEdited) bogumEl.value = incomeVal; }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const didimEl = document.getElementById('didimIncome');
    const bogumEl = document.getElementById('bogumIncome');
    if (didimEl) didimEl.addEventListener('input', () => { didimIncomeEdited = true; });
    if (bogumEl) bogumEl.addEventListener('input', () => { bogumIncomeEdited = true; });

    const incomeEl = document.getElementById('income');
    if (incomeEl) incomeEl.addEventListener('input', () => { syncPolicyIncome(false); });
  });

  /* ---------- UI ìŠ¤ìœ„ì¹˜ ---------- */
  function switchDomain() {
    const domain = document.querySelector('input[name="loanDomain"]:checked').value;
    document.getElementById('bankPanel').classList.toggle('hide', domain !== 'bank');
    document.getElementById('policyPanel').classList.toggle('hide', domain !== 'policy');
    if (domain === 'bank') applyBankPreset();
    if (domain === 'policy') switchPolicy();
    updatePriceCaps();
    if (domain === 'policy') syncPolicyIncome(true);
  }

  function switchPolicy() {
    const p = document.querySelector('input[name="policyType"]:checked').value;
    document.getElementById('didimPanel').classList.toggle('hide', p !== 'didim');
    document.getElementById('bogumPanel').classList.toggle('hide', p !== 'bogum');
    if (p === 'didim') { document.getElementById('ltvInput').value = 70; document.getElementById('dtiInput').value = 60; document.getElementById('dsrInput').value = 0; }
    if (p === 'bogum') {
      const non = document.getElementById('bogumNonApt').value === 'yes';
      document.getElementById('ltvInput').value = non ? 55 : 60;
      document.getElementById('dtiInput').value = 50;
      document.getElementById('dsrInput').value = 0;
    }
    updatePriceCaps();
    syncPolicyIncome(true);
  }

  /* ---------- ê¸ˆìœµê¶Œ ê·œì¹™ í”„ë¦¬ì…‹ ---------- */
  function applyBankPreset() {
    const borrower = document.querySelector('input[name="bankBorrower"]:checked').value; // general | first | seomin
    const isSpec   = document.getElementById('speculativeArea').checked;                // íˆ¬ê¸°ê³¼ì—´ì§€êµ¬
    const isCapital= document.getElementById('capitalArea').checked;                    // ìˆ˜ë„ê¶Œ
    const tier     = document.getElementById('bankTier').value;                         // tier1 | tier2

    let ltv = 70, dti = 60, dsr = (tier === 'tier2' ? 50 : 40);

    if (borrower === 'first') {
      ltv = 70; dti = 60;
    } else if (borrower === 'seomin') {
      if (isSpec) { ltv = 60; dti = 60; }
      else { ltv = 70; dti = 60; }
    } else {
      if (isSpec) { ltv = 40; dti = 40; }
      else { ltv = 70; dti = 60; }
    }

    document.getElementById('ltvInput').value = ltv;
    document.getElementById('dtiInput').value = dti;
    document.getElementById('dsrInput').value = dsr;

    document.getElementById('stressAutoInfo').classList.toggle('hide', !isCapital);
    updatePriceCaps();
  }

  /* ---------- ë¶€ë™ì‚° ê°€ê²© í•œë„ ë°°ì§€ ì—…ë°ì´íŠ¸ ---------- */
  function updatePriceCaps() {
    const capsEl = document.getElementById('priceCaps');
    const domain = document.querySelector('input[name="loanDomain"]:checked').value;

    const seominCap = 'ì„œë¯¼Â·ì‹¤ìˆ˜ìš”ì â‰¤ 8ì–µ';
    let didimCap = 'ë””ë”¤ëŒ â‰¤ 5ì–µ';
    const didimKind = document.querySelector('input[name="didimKind"]:checked');
    if (didimKind && didimKind.value === 'newlyweds') didimCap = 'ë””ë”¤ëŒ(ì‹ í˜¼Â·2ìë…€) â‰¤ 6ì–µ';
    const bogumCap = 'ë³´ê¸ˆìë¦¬ë¡  â‰¤ 6ì–µ';

    const borrower = document.querySelector('input[name="bankBorrower"]:checked')?.value || '';
    const isBankSeomin = (domain === 'bank' && borrower === 'seomin');
    const isPolicyDidim = (domain === 'policy' && document.querySelector('input[name="policyType"]:checked')?.value === 'didim');
    const isPolicyBogum = (domain === 'policy' && document.querySelector('input[name="policyType"]:checked')?.value === 'bogum');

    capsEl.innerHTML = `
      <span class="pill" style="${isBankSeomin ? 'font-weight:700;' : ''}">ê¸ˆìœµê¶Œ-ì„œë¯¼Â·ì‹¤ìˆ˜ìš”ì: ${seominCap}</span>
      <span class="pill" style="${isPolicyDidim ? 'font-weight:700;' : ''}">${didimCap}</span>
      <span class="pill" style="${isPolicyBogum ? 'font-weight:700;' : ''}">${bogumCap}</span>
    `;
  }

  /* ---------- ê³„ì‚° ---------- */
  function convertToEok(amount) { return (amount / 10000).toFixed(2); }

  function calculateLoan() {
    const income = parseFloat(document.getElementById('income').value);
    const propertyPrice = parseFloat(document.getElementById('propertyPrice').value);
    const existingLoanMonthly = parseFloat(document.getElementById('existingLoanMonthly').value) || 0;
    const originalInterestRate = parseFloat(document.getElementById('interestRate').value) / 100;
    const loanTerm = parseInt(document.getElementById('loanTerm').value);

    let ltv = parseFloat(document.getElementById('ltvInput').value) / 100;
    let dti = parseFloat(document.getElementById('dtiInput').value) / 100;
    let dsr = parseFloat(document.getElementById('dsrInput').value) / 100;

    const domain = document.querySelector('input[name="loanDomain"]:checked').value;
    const repaymentType = document.querySelector('input[name="repaymentType"]:checked').value;

    if ([income, propertyPrice, originalInterestRate, loanTerm, ltv, dti, dsr].some(x => isNaN(x))) {
      document.getElementById('eligibility').classList.add('hide');
      document.getElementById('result').innerHTML = '<div class="error">ëª¨ë“  í•„ìˆ˜ ê°’ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
      return;
    }

    let stressInterestRate = originalInterestRate;
    const isCapital = document.getElementById('capitalArea').checked;
    if (domain === 'bank' && isCapital) stressInterestRate += 0.03; // ìˆ˜ë„ê¶Œ ìë™ +3%

    const months = loanTerm * 12;

    // LTV í•œë„
    const ltvLimit = propertyPrice * ltv;

    // DTI í•œë„
    const monthlyInterestRate = originalInterestRate / 12;
    const annuityFactor = monthlyInterestRate === 0
      ? 1 / months
      : (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, months)) / (Math.pow(1 + monthlyInterestRate, months) - 1);
    const yearlyRepaymentPerLoan = annuityFactor * 12;
    const dtiLimit = (income * dti) / yearlyRepaymentPerLoan;

    // DSR í•œë„
    const stressMonthly = stressInterestRate / 12;
    const noStressMonthly = originalInterestRate / 12;

    const maxDSRMonthly = (income * dsr) / 12;
    const availableMonthlyDSR = maxDSRMonthly - existingLoanMonthly;

    let dsrLimit = Infinity;
    let dsrLimitNoStress = Infinity;

    if (dsr > 0) {
      if (availableMonthlyDSR > 0) {
        dsrLimit = (stressMonthly === 0)
          ? availableMonthlyDSR * months
          : availableMonthlyDSR * (1 - Math.pow(1 + stressMonthly, -months)) / stressMonthly;
        dsrLimitNoStress = (noStressMonthly === 0)
          ? availableMonthlyDSR * months
          : availableMonthlyDSR * (1 - Math.pow(1 + noStressMonthly, -months)) / noStressMonthly;
      } else {
        dsrLimit = 0;
        dsrLimitNoStress = 0;
      }
    }

    let limits = [
      { type: "LTV", amount: ltvLimit },
      { type: "DTI", amount: dtiLimit },
      { type: "DSR", amount: dsrLimit }
    ];

    // ê¸ˆìœµê¶Œ ê°€ê²© êµ¬ê°„ í•œë„
    if (domain === 'bank') {
      if (propertyPrice > 150000 && propertyPrice <= 250000) {
        limits.push({ type: "ê°€ê²©êµ¬ê°„ ì •ì±…í•œë„(15~25ì–µ: 4ì–µ)", amount: 40000 });
      } else if (propertyPrice > 250000) {
        limits.push({ type: "ê°€ê²©êµ¬ê°„ ì •ì±…í•œë„(25ì–µì´ˆê³¼: 2ì–µ)", amount: 20000 });
      }
    }

    // ìê²© ê²½ê³ 
    const eligDiv = document.getElementById('eligibility');
    eligDiv.classList.add('hide');
    eligDiv.innerHTML = '';

    if (domain === 'bank') {
      const borrower = document.querySelector('input[name="bankBorrower"]:checked').value;
      if (borrower === 'seomin' && propertyPrice > 80000) {
        eligDiv.classList.remove('hide');
        eligDiv.innerHTML = `<div class="warn"><b>ìê²©í™•ì¸ í•„ìš”</b><br>â€¢ ì„œë¯¼Â·ì‹¤ìˆ˜ìš”ì: ì£¼íƒê°€ê²© <b>8ì–µì› ì´í•˜</b> ìš”ê±´ ìœ„ë°˜</div>`;
      }
    }

    // ì •ì±…ì„±: ìê²©ê²€ì¦ + ìƒí’ˆí•œë„
    if (domain === 'policy') {
      const p = document.querySelector('input[name="policyType"]:checked').value;

      if (p === 'didim') {
        const kind = document.querySelector('input[name="didimKind"]:checked').value;
        const didimIncome = parseFloat(document.getElementById('didimIncome').value || '0');
        const didimAsset = parseFloat(document.getElementById('didimAsset').value || '0');
        const didimNoHouse = document.getElementById('didimNoHouse').checked;

        const reasons = [];
        const priceOk = (kind === 'newlyweds') ? (propertyPrice <= 60000) : (propertyPrice <= 50000);
        if (!priceOk) reasons.push('ë””ë”¤ëŒ ê°€ê²© ìš”ê±´ ìœ„ë°˜ (ê¸°ë³¸ â‰¤5ì–µ, ì‹ í˜¼Â·2ìë…€ â‰¤6ì–µ)');
        let incCap = 6000;
        if (kind === 'first' || kind === 'newlyweds') incCap = 7000;
        if (kind === 'newlyweds') incCap = 8500;
        if (didimIncome <= 0 || didimIncome > incCap) reasons.push(`ì†Œë“ ìš”ê±´ (â‰¤${incCap}ë§Œì›) ìœ„ë°˜`);
        if (!didimNoHouse) reasons.push('ë¬´ì£¼íƒ ì„¸ëŒ€ì£¼ ìš”ê±´ í•„ìš”');
        if (didimAsset <= 0 || didimAsset > 48800) reasons.push('í•©ì‚° ìˆœìì‚° > 4.88ì–µì›');

        if (reasons.length) {
          eligDiv.classList.remove('hide');
          eligDiv.innerHTML = `<div class="warn"><b>ìê²©í™•ì¸ í•„ìš”</b><br>â€¢ ${reasons.join('<br>â€¢ ')}</div>`;
        }

        let prodCap = 20000;
        if (kind === 'first') prodCap = 24000;
        if (kind === 'newlyweds') prodCap = 32000;
        if (kind === 'newborn') prodCap = 40000;
        limits.push({ type: "ìƒí’ˆí•œë„(ë””ë”¤ëŒ)", amount: prodCap });

      } else if (p === 'bogum') {
        const kind = document.querySelector('input[name="bogumKind"]:checked').value;
        const bogumIncome = parseFloat(document.getElementById('bogumIncome').value || '0');
        const nonApt = document.getElementById('bogumNonApt').value === 'yes';
        const bogumNoHouse = document.getElementById('bogumNoHouse').checked;

        const reasons = [];
        if (propertyPrice > 60000) reasons.push('ë³´ê¸ˆìë¦¬ë¡  ê°€ê²© ìš”ê±´ ìœ„ë°˜ (â‰¤6ì–µ)');
        if (bogumIncome <= 0 || bogumIncome > 7000) reasons.push('ì†Œë“ ìš”ê±´ (â‰¤7ì²œë§Œì›) ìœ„ë°˜');
        if (!bogumNoHouse) reasons.push('ë¬´ì£¼íƒ(ë˜ëŠ” 1ì£¼íƒ ìš”ê±´) í™•ì¸ í•„ìš”');

        if (reasons.length) {
          eligDiv.classList.remove('hide');
          eligDiv.innerHTML = `<div class="warn"><b>ìê²©í™•ì¸ í•„ìš”</b><br>â€¢ ${reasons.join('<br>â€¢ ')}</div>`;
        }

        let prodCap = (kind === 'first') ? 42000 : 36000;
        limits.push({ type: "ìƒí’ˆí•œë„(ë³´ê¸ˆìë¦¬ë¡ )", amount: prodCap });
      }
    }

    // ìµœì¢… í•œë„
    const minLoan = limits.reduce((m, c) => (c.amount < m.amount ? c : m), limits[0]);
    const finalLoan = minLoan.amount;
    const reason = minLoan.type;

    // ì›” ìƒí™˜ì•¡ ê³„ì‚°
    const r = originalInterestRate / 12;
    const N = months;
    let monthlyPayment, monthlyPrincipal, monthlyInterest;
    if (repaymentType === "equalPrincipalInterest") {
      monthlyPayment = (r === 0) ? finalLoan / N : finalLoan * r / (1 - Math.pow(1 + r, -N));
      monthlyPrincipal = finalLoan / N;
      monthlyInterest = monthlyPayment - monthlyPrincipal;
    } else {
      monthlyPrincipal = finalLoan / N;
      monthlyInterest = finalLoan * r; // ì²«ë‹¬ ì´ì
      monthlyPayment = monthlyPrincipal + monthlyInterest;
    }

    const avgMonthlyIncome = income / 12;
    const monthlyGap = avgMonthlyIncome - monthlyPayment;
    const repaymentRatio = (monthlyPayment / avgMonthlyIncome) * 100;

    // ìŠ¤íŠ¸ë ˆìŠ¤ ë¼ì¸ (ìˆ˜ë„ê¶Œ +3%ì¼ ë•Œë§Œ í‘œì‹œ)
    let stressLine = '';
    if (domain === 'bank' && isCapital) {
      stressLine = `<div class="pill">DSR ìŠ¤íŠ¸ë ˆìŠ¤ ê¸ˆë¦¬: ${(stressInterestRate*100).toFixed(2)}% (ìˆ˜ë„ê¶Œ ìë™ +3%)</div>`;
    }

    const dsrLine = (dsr === 0)
      ? 'ë¹„ì ìš©'
      : `${convertToEok(dsrLimit)}ì–µì›${(domain === 'bank' && isCapital) ? ` <span class="subtle">(ìŠ¤íŠ¸ë ˆìŠ¤ ë¯¸ì ìš©ì‹œ ${convertToEok(dsrLimitNoStress)}ì–µì›)</span>` : ''}`;

    let limitsHtml =
      `<strong>LTV í•œë„:</strong> ${convertToEok(ltvLimit)}ì–µì›<br>` +
      `<strong>DTI í•œë„:</strong> ${convertToEok(dtiLimit)}ì–µì›<br>` +
      `<strong>DSR í•œë„:</strong> ${dsrLine}<br>`;

    limits.filter(x => x.type.includes('ì •ì±…í•œë„') || x.type.includes('ìƒí’ˆí•œë„'))
      .forEach(x => { limitsHtml += `<strong>${x.type}:</strong> ${convertToEok(x.amount)}ì–µì›<br>`; });

    document.getElementById('result').innerHTML =
      `${limitsHtml}
       ${stressLine}
       <hr>
       ğŸ’¡ <strong>ìµœì¢… ëŒ€ì¶œ í•œë„ëŠ” <u>${reason}</u> ê¸°ì¤€ìœ¼ë¡œ <u>${convertToEok(finalLoan)}ì–µì›</u>ì…ë‹ˆë‹¤.</strong><br><br>
       <strong>ì›” ìƒí™˜ê¸ˆ:</strong> ${Math.floor(monthlyPayment)}ë§Œì› (${repaymentType === "equalPrincipalInterest" ? "ì›ë¦¬ê¸ˆ ê· ë“±" : "ì›ê¸ˆ ê· ë“±(ì²«ë‹¬)"})<br>
       - ì›” ì›ê¸ˆ: <strong>${Math.floor(monthlyPrincipal)}ë§Œì›</strong><br>
       - ì›” ì´ì: <strong>${Math.floor(monthlyInterest)}ë§Œì›</strong><br>
       <hr><strong>ğŸ“Š ì›” ì†Œë“ ë¶„ì„</strong><br>
       - í‰ê·  ì›”ê¸‰: <strong>${Math.floor(avgMonthlyIncome)}ë§Œì›</strong><br>
       - ì›” ìƒí™˜ í›„ ë‚¨ëŠ” ê¸ˆì•¡: <strong>${Math.floor(monthlyGap)}ë§Œì›</strong><br>
       - ìƒí™˜ ë¹„ìœ¨: <strong>${repaymentRatio.toFixed(1)}%</strong>`;
  }

  /* === íˆ´íŒ: ëª¨ë°”ì¼/ë°ìŠ¤í¬íƒ‘ ê³µí†µ í† ê¸€ === */
  (function tooltipInit(){
    const wrap = document.getElementById('tipSpecWrap');
    const btn  = document.getElementById('tipBtn');
    if (!wrap || !btn) return;

    const toggle = (force) => {
      const willOpen = (typeof force === 'boolean') ? force : !wrap.classList.contains('open');
      wrap.classList.toggle('open', willOpen);
      btn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
    };
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(); });
    btn.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }
    });

    document.addEventListener('click', (e)=>{
      if (!wrap.contains(e.target)) toggle(false);
    });

    window.addEventListener('scroll', ()=> toggle(false), { passive:true });
    window.addEventListener('resize', ()=> toggle(false));
  })();

  // ì´ˆê¸° ì„¸íŒ…
  switchDomain();
</script>
</body>
</html>

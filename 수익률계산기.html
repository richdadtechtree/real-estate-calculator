<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¶€íƒœë¦¬ ì‹¤ì „ íˆ¬ì ìµœì¢… ë¶„ì„ê¸°</title>
    <style>
        :root {
            --bg: #0b0c10; --card: #151822; --text: #e8eaf0; --muted: #96a0b5;
            --accent: #4caf50; --accent-weak: #3a8f40; --ring: rgba(76,175,80,.35);
            --blue: #2196f3; --orange: #ff9800; --purple: #9c27b0;
        }
        body {
            background: linear-gradient(180deg, #0b0c10 0%, #0f1220 100%);
            color: var(--text); font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px;
        }
        .container {
            max-width: 650px; margin: 0 auto; background: var(--card);
            padding: 30px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.06);
        }
        h2 { text-align: center; color: var(--text); margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 700; color: var(--muted); font-size: 13px; }

        /* ë¹„ê³¼ì„¸ í•­ëª© ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .highlight-label { color: var(--accent) !important; font-weight: 800; }
        #isExempt { border: 1px solid var(--accent-weak); color: var(--accent); font-weight: bold; }

        input, select {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06);
            background: rgba(255,255,255,0.05); color: #fff; font-size: 16px; box-sizing: border-box;
        }
        .korean-unit { display: block; margin-top: 5px; font-size: 12px; color: var(--accent); min-height: 1.2em; }
        .row { display: flex; gap: 12px; margin-bottom: 18px; }
        .row > div { flex: 1; }

        .section-box {
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08);
            padding: 20px; border-radius: 12px; margin: 20px 0;
        }

        /* íˆ¬ì ìœ í˜• ì„ íƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .invest-type-selector {
            display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;
        }
        .invest-type-btn {
            flex: 1; min-width: 120px; padding: 15px 10px; border: 2px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03); border-radius: 12px; cursor: pointer;
            text-align: center; transition: all 0.3s;
        }
        .invest-type-btn:hover {
            background: rgba(255,255,255,0.08); transform: translateY(-2px);
        }
        .invest-type-btn.active {
            border-color: var(--accent); background: rgba(76,175,80,0.15);
        }
        .invest-type-btn.active.stock-kr { border-color: var(--blue); background: rgba(33,150,243,0.15); }
        .invest-type-btn.active.stock-us { border-color: var(--orange); background: rgba(255,152,0,0.15); }
        .invest-type-btn.active.other { border-color: var(--purple); background: rgba(156,39,176,0.15); }

        .invest-type-btn .icon { font-size: 24px; margin-bottom: 5px; }
        .invest-type-btn .label { font-size: 13px; font-weight: 700; color: var(--text); }
        .invest-type-btn .desc { font-size: 10px; color: var(--muted); margin-top: 3px; }

        .checkbox-label {
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            font-size: 16px; font-weight: bold; color: var(--accent);
        }
        input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--accent); cursor: pointer; }

        button {
            width: 100%; padding: 18px; background: var(--accent); color: #fff;
            border: none; border-radius: 999px; font-size: 18px; font-weight: 800; cursor: pointer;
            transition: 0.2s; margin-top: 10px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px var(--ring); }

        /* ê²°ê³¼ ì°½ ìŠ¤íƒ€ì¼ */
        .roi-header {
            text-align: center; padding: 35px; border-radius: 15px;
            background: rgba(76,175,80,0.08); border: 1px solid var(--accent-weak);
            margin-top: 30px; display: none;
        }
        .highlight-net { color: #ffb1b1; font-size: 40px; font-weight: 900; margin: 10px 0; }
        .highlight-roi { color: var(--accent); font-size: 24px; font-weight: 700; }

        /* ì‹œê°ì  ì‚°ì‹ ë””ìì¸ */
        .formula-container {
            display: flex; align-items: center; justify-content: center;
            margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.4);
            border-radius: 12px; font-family: 'Courier New', monospace; font-size: 13px; color: #fff;
        }
        .fraction { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; }
        .numerator { border-bottom: 1px solid #777; padding: 0 10px 5px 10px; color: #ffb1b1; }
        .denominator { padding: 5px 10px 0 10px; color: #add8e6; }
        .math-symbol { font-size: 18px; margin: 0 12px; color: var(--muted); }

        .analysis-table {
            width: 100%; border-collapse: collapse; margin-top: 25px; background: #fff;
            border-radius: 10px; overflow: hidden; color: #333; display: none;
        }
        .analysis-table th, .analysis-table td { padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 14px; }
        .analysis-table th { background: #f8f9fa; color: #666; text-align: left; }
        .analysis-table td { text-align: right; font-weight: 600; }
        .row-group { background: #f1f3f5; font-weight: bold; }
        .row-tax { color: #d63301; background: #fff5f5; }

        .info-box {
            background: rgba(33,150,243,0.1); border: 1px solid rgba(33,150,243,0.3);
            padding: 12px 15px; border-radius: 8px; margin-top: 15px; font-size: 12px; color: var(--muted);
        }
        .info-box.warning {
            background: rgba(255,152,0,0.1); border-color: rgba(255,152,0,0.3);
        }

        .checkbox-label-small {
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            font-size: 13px; font-weight: 600; color: var(--orange);
        }
        .checkbox-label-small input[type="checkbox"] {
            width: 16px; height: 16px; accent-color: var(--orange);
        }
        .target-mode-active {
            border-color: var(--orange) !important;
            background: rgba(255,152,0,0.1) !important;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ì‹¤ì „ íˆ¬ì ì„¸í›„ ìˆ˜ìµë¥  ë¶„ì„</h2>

    <!-- íˆ¬ì ìœ í˜• ì„ íƒ -->
    <div class="section-box">
        <label style="margin-bottom: 15px;">íˆ¬ì ìœ í˜• ì„ íƒ</label>
        <div class="invest-type-selector">
            <div class="invest-type-btn active" onclick="selectInvestType('realestate')" id="btn-realestate">
                <div class="icon">ğŸ </div>
                <div class="label">ë¶€ë™ì‚°</div>
                <div class="desc">ì·¨ë“ì„¸/ì–‘ë„ì„¸ ë°˜ì˜</div>
            </div>
            <div class="invest-type-btn stock-kr" onclick="selectInvestType('stock-kr')" id="btn-stock-kr">
                <div class="icon">ğŸ‡°ğŸ‡·</div>
                <div class="label">êµ­ë‚´ì£¼ì‹</div>
                <div class="desc">ìˆ˜ìˆ˜ë£Œ ë°˜ì˜</div>
            </div>
            <div class="invest-type-btn stock-us" onclick="selectInvestType('stock-us')" id="btn-stock-us">
                <div class="icon">ğŸ‡ºğŸ‡¸</div>
                <div class="label">ë¯¸êµ­ì£¼ì‹</div>
                <div class="desc">ì–‘ë„ì„¸ 22% + ìˆ˜ìˆ˜ë£Œ</div>
            </div>
            <div class="invest-type-btn other" onclick="selectInvestType('other')" id="btn-other">
                <div class="icon">ğŸ“Š</div>
                <div class="label">ê¸°íƒ€</div>
                <div class="desc">ì§ì ‘ ë¹„ìš© ì…ë ¥</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div>
            <label>í˜„ê¸ˆ íˆ¬ì ì›ê¸ˆ</label>
            <input type="number" id="investment" oninput="updateKorean('investment', 'korInv')">
            <span id="korInv" class="korean-unit"></span>
        </div>
        <div>
            <label>íˆ¬ì ê¸°ê°„ (ë…„)</label>
            <input type="number" id="period" value="2" step="0.1">
        </div>
    </div>

    <!-- ëŒ€ì¶œ ì„¹ì…˜ (ë¶€ë™ì‚°/ê¸°íƒ€) -->
    <div class="row" id="loanSection">
        <div>
            <label>ëŒ€ì¶œê¸ˆì•¡</label>
            <input type="number" id="loan" value="0" oninput="updateKorean('loan', 'korLoan')">
            <span id="korLoan" class="korean-unit"></span>
        </div>
        <div>
            <label>ê¸ˆë¦¬ (%)</label>
            <input type="number" id="rate" step="0.1" value="4.5">
        </div>
    </div>

    <!-- ë¶€ë™ì‚° ì „ìš© í•„ë“œ -->
    <div id="reFields">
        <div class="row">
            <div>
                <label>ë¶€ë™ì‚° ë§¤ì…ê°€</label>
                <input type="number" id="buyPrice" oninput="updateKorean('buyPrice', 'korBuy')">
                <span id="korBuy" class="korean-unit"></span>
            </div>
            <div>
                <label class="highlight-label">1ì£¼íƒ ë¹„ê³¼ì„¸ ì—¬ë¶€</label>
                <select id="isExempt" onchange="toggleResidenceField()">
                    <option value="y">ì ìš© (12ì–µ ì´í•˜ ë¹„ê³¼ì„¸)</option>
                    <option value="n">ë¯¸ì ìš© (ì¼ë°˜ ê³¼ì„¸)</option>
                </select>
            </div>
        </div>
        <!-- ê±°ì£¼ê¸°ê°„ ì…ë ¥ (ë¹„ê³¼ì„¸ ë¯¸ì ìš© ì‹œì—ë§Œ í‘œì‹œ) -->
        <div class="row" id="residenceRow" style="display:none;">
            <div>
                <label>ê±°ì£¼ê¸°ê°„ (ë…„)</label>
                <input type="number" id="residencePeriod" step="0.1" value="0" placeholder="ì‹¤ê±°ì£¼ ê¸°ê°„">
                <span class="korean-unit" style="color:var(--blue);">ë³´ìœ ê¸°ê°„ì€ íˆ¬ìê¸°ê°„ ì‚¬ìš©</span>
            </div>
            <div>
                <label>í•„ìš”ê²½ë¹„ (ì¤‘ê°œë¹„ ì™¸ ì¶”ê°€)</label>
                <input type="number" id="additionalExpense" value="0" oninput="updateKorean('additionalExpense', 'korAddExp')">
                <span id="korAddExp" class="korean-unit"></span>
            </div>
        </div>
        <div id="residenceInfo" class="info-box" style="display:none;">
            <strong>ì¥ê¸°ë³´ìœ íŠ¹ë³„ê³µì œ (3ë…„ ì´ìƒ ë³´ìœ  ì‹œ ì ìš©):</strong><br>
            â€¢ 2ë…„ ì´ìƒ ê±°ì£¼: ë³´ìœ  4%/ë…„(ìµœëŒ€40%) + ê±°ì£¼ 4%/ë…„(ìµœëŒ€40%) = ìµœëŒ€ 80%<br>
            â€¢ 2ë…„ ë¯¸ë§Œ ê±°ì£¼: ë³´ìœ  2%/ë…„ = ìµœëŒ€ 30%<br>
            â€¢ 3ë…„ ë¯¸ë§Œ ë³´ìœ  ì‹œ: ê³µì œ ì—†ìŒ
        </div>
    </div>

    <!-- êµ­ë‚´ì£¼ì‹ ì „ìš© í•„ë“œ -->
    <div id="stockKrFields" style="display:none;">
        <div class="row">
            <div>
                <label>ì¦ê¶Œì‚¬ ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label>
                <input type="number" id="krFeeRate" step="0.001" value="0.015" placeholder="ì˜ˆ: 0.015">
            </div>
            <div>
                <label>ê±°ë˜ì„¸ìœ¨ (%)</label>
                <input type="number" id="krTaxRate" step="0.01" value="0.18" placeholder="ì½”ìŠ¤í”¼ 0.18%">
            </div>
        </div>
        <div class="info-box">
            ì¼ë°˜ ê°œì¸íˆ¬ììëŠ” ì–‘ë„ì†Œë“ì„¸ ë¹„ê³¼ì„¸ (ëŒ€ì£¼ì£¼ ì œì™¸)<br>
            ìˆ˜ìˆ˜ë£Œ: ë§¤ìˆ˜/ë§¤ë„ ê°ê° ì ìš© | ê±°ë˜ì„¸: ë§¤ë„ ì‹œì—ë§Œ ì ìš©
        </div>
    </div>

    <!-- ë¯¸êµ­ì£¼ì‹ ì „ìš© í•„ë“œ -->
    <div id="stockUsFields" style="display:none;">
        <div class="row">
            <div>
                <label>ì¦ê¶Œì‚¬ ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label>
                <input type="number" id="usFeeRate" step="0.001" value="0.25" placeholder="ì˜ˆ: 0.25">
            </div>
            <div>
                <label>í™˜ì „ ìŠ¤í”„ë ˆë“œ (%)</label>
                <input type="number" id="usExchangeRate" step="0.01" value="0.25" placeholder="ì˜ˆ: 0.25">
            </div>
        </div>
        <div class="info-box warning">
            <strong>ë¯¸êµ­ì£¼ì‹ ì–‘ë„ì†Œë“ì„¸:</strong> ì—° 250ë§Œì› ê¸°ë³¸ê³µì œ í›„ 22% (ì†Œë“ì„¸ 20% + ì§€ë°©ì„¸ 2%)<br>
            ìˆ˜ìˆ˜ë£Œ: ë§¤ìˆ˜/ë§¤ë„ ê°ê° ì ìš© | í™˜ì „: ë§¤ìˆ˜/ë§¤ë„ ê°ê° ì ìš©
        </div>
    </div>

    <!-- ê¸°íƒ€ íˆ¬ì ì „ìš© í•„ë“œ -->
    <div id="otherFields" style="display:none;">
        <div class="row">
            <div>
                <label>ì˜ˆìƒ ì´ ìˆ˜ìˆ˜ë£Œ/ë¹„ìš©</label>
                <input type="number" id="otherFee" value="0" oninput="updateKorean('otherFee', 'korOtherFee')">
                <span id="korOtherFee" class="korean-unit"></span>
            </div>
            <div>
                <label>ì˜ˆìƒ ì„¸ê¸ˆ</label>
                <input type="number" id="otherTax" value="0" oninput="updateKorean('otherTax', 'korOtherTax')">
                <span id="korOtherTax" class="korean-unit"></span>
            </div>
        </div>
        <div class="info-box">
            ê¸°íƒ€ íˆ¬ìì˜ ê²½ìš° ìˆ˜ìˆ˜ë£Œì™€ ì„¸ê¸ˆì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.
        </div>
    </div>

    <div class="input-group">
        <div class="row" style="align-items: center; margin-bottom: 8px;">
            <label id="profitLabel" style="margin-bottom: 0; flex: 1;">ì˜ˆìƒ ì‹œì„¸ ì°¨ìµ (ë§¤ë„ê°€ - ë§¤ìˆ˜ê°€)</label>
            <label class="checkbox-label-small">
                <input type="checkbox" id="isTargetNet" onchange="toggleTargetMode()">
                <span>ì‹¤ì œ ìˆ˜ë ¹ ê¸ˆì•¡</span>
            </label>
        </div>
        <input type="number" id="expectedProfit" oninput="updateKorean('expectedProfit', 'korProfit')">
        <span id="korProfit" class="korean-unit"></span>
    </div>

    <!-- ì—­ê³„ì‚° ê²°ê³¼ í‘œì‹œ -->
    <div id="reverseCalcResult" class="info-box" style="display:none; margin-bottom: 15px; background: rgba(76,175,80,0.1); border-color: rgba(76,175,80,0.3);">
        <strong>í•„ìš” ì‹œì„¸ ì°¨ìµ:</strong> <span id="requiredProfit">0</span>ì›<br>
        <strong>í•„ìš” ë§¤ë„ê°€:</strong> <span id="requiredSalePrice">0</span>ì›
    </div>

    <button onclick="runAnalysis()">ìˆ˜ìµë¥  ë° ìˆœìˆ˜ìµ ë¶„ì„</button>

    <div class="roi-header" id="roiHeader">
        <div style="font-size:13px; color:var(--muted);">ëª¨ë“  ê³µì œ í›„ ìµœì¢… ì‹¤ì§ˆ ìˆœìˆ˜ìµ</div>
        <div id="resNet" class="highlight-net">0ì›</div>
        <div id="resAnnualROI" class="highlight-roi">0%</div>
        <div style="font-size:12px; color:var(--muted); margin-top:5px;">(ì—°í‰ê·  ì‹¤ì§ˆ ìˆ˜ìµë¥ )</div>

        <div class="formula-container">
            <div class="fraction">
                <div class="numerator">(<span id="f-profit">0</span> - <span id="f-exp">0</span> - <span id="f-int">0</span>)</div>
                <div class="denominator">(<span id="f-inv">0</span> Ã— <span id="f-period">0</span>)</div>
            </div>
            <span class="math-symbol">Ã— 100 = </span>
            <span id="f-result" style="font-weight:bold; color:var(--accent);">0%</span>
        </div>
    </div>

    <table class="analysis-table" id="analysisTable">
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    let currentInvestType = 'realestate';
    let isTargetNetMode = false;

    function toggleResidenceField() {
        const isExempt = document.getElementById('isExempt').value === 'y';
        document.getElementById('residenceRow').style.display = isExempt ? 'none' : 'flex';
        document.getElementById('residenceInfo').style.display = isExempt ? 'none' : 'block';
    }

    function toggleTargetMode() {
        isTargetNetMode = document.getElementById('isTargetNet').checked;
        const label = document.getElementById('profitLabel');
        const input = document.getElementById('expectedProfit');

        if (isTargetNetMode) {
            label.innerText = 'ëª©í‘œ ì‹¤ìˆ˜ë ¹ì•¡ (ì„¸í›„ ìˆœìˆ˜ìµ)';
            label.style.color = 'var(--orange)';
            input.classList.add('target-mode-active');
        } else {
            label.innerText = 'ì˜ˆìƒ ì‹œì„¸ ì°¨ìµ (ë§¤ë„ê°€ - ë§¤ìˆ˜ê°€)';
            label.style.color = 'var(--muted)';
            input.classList.remove('target-mode-active');
            document.getElementById('reverseCalcResult').style.display = 'none';
        }
    }

    function numberToKorean(n) {
        if (!n || isNaN(n)) return "";
        const units = ['', 'ë§Œ', 'ì–µ', 'ì¡°'];
        let res = []; let i = 0;
        while (n > 0) {
            let mod = n % 10000;
            if (mod > 0) res.push(mod.toLocaleString() + units[i]);
            n = Math.floor(n / 10000); i++;
        }
        return res.reverse().join(' ') + " ì›";
    }

    function updateKorean(id, spanId) {
        const val = document.getElementById(id).value;
        document.getElementById(spanId).innerText = numberToKorean(Number(val));
    }

    function selectInvestType(type) {
        currentInvestType = type;

        // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
        document.querySelectorAll('.invest-type-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-' + type).classList.add('active');

        // ëª¨ë“  í•„ë“œ ìˆ¨ê¸°ê¸°
        document.getElementById('reFields').style.display = 'none';
        document.getElementById('stockKrFields').style.display = 'none';
        document.getElementById('stockUsFields').style.display = 'none';
        document.getElementById('otherFields').style.display = 'none';
        document.getElementById('loanSection').style.display = 'none';

        // í•´ë‹¹ ìœ í˜• í•„ë“œ í‘œì‹œ
        if (type === 'realestate') {
            document.getElementById('reFields').style.display = 'block';
            document.getElementById('loanSection').style.display = 'flex';
            toggleResidenceField(); // ë¹„ê³¼ì„¸ ì—¬ë¶€ì— ë”°ë¼ ê±°ì£¼ê¸°ê°„ í•„ë“œ í‘œì‹œ
        } else if (type === 'stock-kr') {
            document.getElementById('stockKrFields').style.display = 'block';
        } else if (type === 'stock-us') {
            document.getElementById('stockUsFields').style.display = 'block';
        } else if (type === 'other') {
            document.getElementById('otherFields').style.display = 'block';
            document.getElementById('loanSection').style.display = 'flex';
        }

        // ê²°ê³¼ ì´ˆê¸°í™”
        document.getElementById('roiHeader').style.display = 'none';
        document.getElementById('analysisTable').style.display = 'none';
        document.getElementById('reverseCalcResult').style.display = 'none';
    }

    // ì¥ê¸°ë³´ìœ íŠ¹ë³„ê³µì œìœ¨ ê³„ì‚° (3ë…„ ì´ìƒ ë³´ìœ  ì‹œì—ë§Œ ì ìš©)
    function calculateLongTermDeduction(holdingPeriod, residencePeriod) {
        // 3ë…„ ë¯¸ë§Œ ë³´ìœ  ì‹œ ê³µì œ ì—†ìŒ
        if (holdingPeriod < 3) return 0;

        let rate = 0;

        if (residencePeriod >= 2) {
            // 2ë…„ ì´ìƒ ê±°ì£¼: ë³´ìœ  4%/ë…„(ìµœëŒ€40%) + ê±°ì£¼ 4%/ë…„(ìµœëŒ€40%) = ìµœëŒ€ 80%
            const holdingRate = Math.min(Math.floor(holdingPeriod) * 0.04, 0.40);
            const residenceRate = Math.min(Math.floor(residencePeriod) * 0.04, 0.40);
            rate = holdingRate + residenceRate;
        } else {
            // 2ë…„ ë¯¸ë§Œ ê±°ì£¼: ë³´ìœ  2%/ë…„ = ìµœëŒ€ 30%
            rate = Math.min(Math.floor(holdingPeriod) * 0.02, 0.30);
        }

        return Math.min(rate, 0.80); // ìµœëŒ€ 80%
    }

    // ì†Œë“ì„¸ ì„¸ìœ¨ ë° ëˆ„ì§„ê³µì œ ì ìš© (2026ë…„ ê¸°ì¤€)
    function applyTaxRate(taxableIncome) {
        if (taxableIncome <= 0) return { tax: 0, rate: 0, deduction: 0 };

        let tax = 0, rate = 0, deduction = 0;

        if (taxableIncome <= 14e6) {
            rate = 6; deduction = 0;
            tax = taxableIncome * 0.06;
        } else if (taxableIncome <= 50e6) {
            rate = 15; deduction = 126;
            tax = taxableIncome * 0.15 - 1.26e6;
        } else if (taxableIncome <= 88e6) {
            rate = 24; deduction = 576;
            tax = taxableIncome * 0.24 - 5.76e6;
        } else if (taxableIncome <= 150e6) {
            rate = 35; deduction = 1544;
            tax = taxableIncome * 0.35 - 15.44e6;
        } else if (taxableIncome <= 300e6) {
            rate = 38; deduction = 1994;
            tax = taxableIncome * 0.38 - 19.94e6;
        } else if (taxableIncome <= 500e6) {
            rate = 40; deduction = 2594;
            tax = taxableIncome * 0.40 - 25.94e6;
        } else if (taxableIncome <= 1000e6) {
            rate = 42; deduction = 3594;
            tax = taxableIncome * 0.42 - 35.94e6;
        } else {
            rate = 45; deduction = 6594;
            tax = taxableIncome * 0.45 - 65.94e6;
        }

        return { tax, rate, deduction };
    }

    function calculateTax(gain, period, isExempt, salePrice, additionalExp = 0, residencePeriod = 0) {
        if (gain <= 0) return { tax: 0, label: "ìˆ˜ìµ ì—†ìŒ", details: null };

        let details = {
            totalGain: gain,
            taxableGain: 0,
            longTermRate: 0,
            incomeAmount: 0,
            taxBase: 0,
            taxBeforeLocal: 0,
            taxRate: 0,        // ì ìš© ì„¸ìœ¨ (%)
            taxDeduction: 0    // ëˆ„ì§„ê³µì œì•¡ (ë§Œì›)
        };

        // ë‹¨ê¸° ì–‘ë„ (1ë…„ ë¯¸ë§Œ: 70%, 1~2ë…„: 60%)
        if (period < 1) {
            const netGain = gain - 2500000;
            if (netGain <= 0) return { tax: 0, label: "ê¸°ë³¸ê³µì œ ì´í•˜", details: null };
            const tax = netGain * 0.7;
            return { tax: Math.floor(tax * 1.1), label: "70% ë‹¨ê¸°", details: null };
        } else if (period < 2) {
            const netGain = gain - 2500000;
            if (netGain <= 0) return { tax: 0, label: "ê¸°ë³¸ê³µì œ ì´í•˜", details: null };
            const tax = netGain * 0.6;
            return { tax: Math.floor(tax * 1.1), label: "60% ë‹¨ê¸°", details: null };
        }

        // 2ë…„ ì´ìƒ ë³´ìœ  ì‹œ
        if (isExempt) {
            // ë¹„ê³¼ì„¸ ì ìš©
            if (salePrice <= 12e8) return { tax: 0, label: "ë¹„ê³¼ì„¸", details: null };

            // 12ì–µ ì´ˆê³¼ ê³ ê°€ì£¼íƒ: ì´ˆê³¼ë¶„ë§Œ ê³¼ì„¸ (ì¥íŠ¹ê³µ 80% ì ìš©)
            details.taxableGain = gain * ((salePrice - 12e8) / salePrice);
            details.longTermRate = 0.80; // ë¹„ê³¼ì„¸ ìš”ê±´ ì¶©ì¡± ì‹œ ìµœëŒ€ ê³µì œ
            details.incomeAmount = details.taxableGain * (1 - details.longTermRate);
            details.taxBase = Math.max(details.incomeAmount - 2500000, 0);

            const taxResult = applyTaxRate(details.taxBase);
            details.taxBeforeLocal = taxResult.tax;
            details.taxRate = taxResult.rate;
            details.taxDeduction = taxResult.deduction;

            return {
                tax: Math.floor(details.taxBeforeLocal * 1.1),
                label: "12ì–µì´ˆê³¼ ë¹„ê³¼ì„¸",
                details: details
            };
        } else {
            // ë¹„ê³¼ì„¸ ë¯¸ì ìš© (ì¼ë°˜ ê³¼ì„¸)
            // 1. 12ì–µ ì´ˆê³¼ë¶„ë§Œ ê³¼ì„¸
            if (salePrice <= 12e8) {
                // 12ì–µ ì´í•˜ë©´ ì „ì²´ ê³¼ì„¸
                details.taxableGain = gain;
            } else {
                // 12ì–µ ì´ˆê³¼ë¶„ë§Œ ê³¼ì„¸
                details.taxableGain = gain * ((salePrice - 12e8) / salePrice);
            }

            // 2. ì¥ê¸°ë³´ìœ íŠ¹ë³„ê³µì œ ì ìš©
            details.longTermRate = calculateLongTermDeduction(period, residencePeriod);

            // 3. ì–‘ë„ì†Œë“ê¸ˆì•¡ = ê³¼ì„¸ëŒ€ìƒì–‘ë„ì°¨ìµ Ã— (1 - ì¥íŠ¹ê³µìœ¨)
            details.incomeAmount = details.taxableGain * (1 - details.longTermRate);

            // 4. ê³¼ì„¸í‘œì¤€ = ì–‘ë„ì†Œë“ê¸ˆì•¡ - ê¸°ë³¸ê³µì œ(250ë§Œì›)
            details.taxBase = Math.max(details.incomeAmount - 2500000, 0);

            // 5. ì„¸ì•¡ ê³„ì‚° (ëˆ„ì§„ì„¸ìœ¨ ì ìš©)
            const taxResult = applyTaxRate(details.taxBase);
            details.taxBeforeLocal = taxResult.tax;
            details.taxRate = taxResult.rate;
            details.taxDeduction = taxResult.deduction;

            // 6. ì§€ë°©ì„¸ í¬í•¨ (Ã—1.1)
            const finalTax = Math.floor(details.taxBeforeLocal * 1.1);

            let label = salePrice > 12e8 ? "12ì–µì´ˆê³¼ ì¥íŠ¹ê³µ" : "ì¼ë°˜ ì¥íŠ¹ê³µ";
            label += ` ${Math.round(details.longTermRate * 100)}%`;

            return { tax: finalTax, label: label, details: details };
        }
    }

    function calculateUsStockTax(gain) {
        // ë¯¸êµ­ì£¼ì‹ ì–‘ë„ì†Œë“ì„¸: ì—° 250ë§Œì› ê¸°ë³¸ê³µì œ í›„ 22%
        if (gain <= 0) return { tax: 0, label: "ìˆ˜ìµ ì—†ìŒ" };
        const netGain = gain - 2500000; // 250ë§Œì› ê¸°ë³¸ê³µì œ
        if (netGain <= 0) return { tax: 0, label: "ê¸°ë³¸ê³µì œ ì´í•˜" };
        const tax = Math.floor(netGain * 0.22); // 22% (ì†Œë“ì„¸ 20% + ì§€ë°©ì„¸ 2%)
        return { tax: tax, label: "22% ê³¼ì„¸" };
    }

    // ì‹œì„¸ì°¨ìµìœ¼ë¡œë¶€í„° ì´ ë¹„ìš© ê³„ì‚° (ì—­ê³„ì‚°ìš©)
    function calculateTotalExpense(profit, inv, period) {
        let totalExp = 0;
        let interest = 0;

        if (currentInvestType === 'realestate') {
            const loan = parseFloat(document.getElementById('loan').value) || 0;
            const rate = (parseFloat(document.getElementById('rate').value) || 0) / 100;
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const isExempt = document.getElementById('isExempt').value === 'y';
            const salePrice = buyPrice + profit;
            const additionalExp = parseFloat(document.getElementById('additionalExpense').value) || 0;
            const residencePeriod = parseFloat(document.getElementById('residencePeriod').value) || 0;

            interest = loan * rate * period;

            let acqRate = (buyPrice <= 6e8) ? 0.01 : (buyPrice <= 9e8) ? (buyPrice * (2/3e8) - 3) / 100 : 0.03;
            const acq = Math.floor(buyPrice * acqRate);
            const edu = Math.floor(acq * 0.1);
            const legalFees = 880000 + 150000 + 18000;
            const brokerBuy = (buyPrice <= 9e8) ? buyPrice * 0.004 * 1.1 : buyPrice * 0.005 * 1.1;
            const buyExp = acq + edu + legalFees + brokerBuy;

            const taxObj = calculateTax(profit, period, isExempt, salePrice, additionalExp, residencePeriod);
            const brokerSell = brokerBuy;
            totalExp = buyExp + brokerSell + additionalExp + taxObj.tax;

        } else if (currentInvestType === 'stock-kr') {
            const feeRate = (parseFloat(document.getElementById('krFeeRate').value) || 0) / 100;
            const taxRate = (parseFloat(document.getElementById('krTaxRate').value) || 0) / 100;

            const buyFee = Math.floor(inv * feeRate);
            const sellAmount = inv + profit;
            const sellFee = Math.floor(sellAmount * feeRate);
            const tradeTax = Math.floor(sellAmount * taxRate);
            totalExp = buyFee + sellFee + tradeTax;

        } else if (currentInvestType === 'stock-us') {
            const feeRate = (parseFloat(document.getElementById('usFeeRate').value) || 0) / 100;
            const exchangeRate = (parseFloat(document.getElementById('usExchangeRate').value) || 0) / 100;

            const buyFee = Math.floor(inv * feeRate);
            const buyExchange = Math.floor(inv * exchangeRate);
            const sellAmount = inv + profit;
            const sellFee = Math.floor(sellAmount * feeRate);
            const sellExchange = Math.floor(sellAmount * exchangeRate);
            const taxObj = calculateUsStockTax(profit);
            totalExp = buyFee + buyExchange + sellFee + sellExchange + taxObj.tax;

        } else if (currentInvestType === 'other') {
            const loan = parseFloat(document.getElementById('loan').value) || 0;
            const rate = (parseFloat(document.getElementById('rate').value) || 0) / 100;
            const otherFee = parseFloat(document.getElementById('otherFee').value) || 0;
            const otherTax = parseFloat(document.getElementById('otherTax').value) || 0;

            interest = loan * rate * period;
            totalExp = otherFee + otherTax;
        }

        return { totalExp, interest };
    }

    // ëª©í‘œ ìˆœìˆ˜ìµ ë‹¬ì„±ì„ ìœ„í•œ í•„ìš” ì‹œì„¸ì°¨ìµ ì—­ê³„ì‚° (ì´ì§„ íƒìƒ‰)
    function reverseCalculateProfit(targetNet, inv, period) {
        let low = targetNet;
        let high = targetNet * 3; // ì´ˆê¸° ìƒí•œ
        let result = targetNet;

        // ìƒí•œ ì¡°ì • (ë¹„ìš©ì´ ë§ì„ ê²½ìš°)
        for (let i = 0; i < 10; i++) {
            const { totalExp, interest } = calculateTotalExpense(high, inv, period);
            if (high - totalExp - interest >= targetNet) break;
            high *= 2;
        }

        // ì´ì§„ íƒìƒ‰
        for (let i = 0; i < 50; i++) {
            const mid = (low + high) / 2;
            const { totalExp, interest } = calculateTotalExpense(mid, inv, period);
            const netProfit = mid - totalExp - interest;

            if (Math.abs(netProfit - targetNet) < 1000) {
                result = mid;
                break;
            }

            if (netProfit < targetNet) {
                low = mid;
            } else {
                high = mid;
                result = mid;
            }
        }

        return Math.ceil(result);
    }

    function runAnalysis() {
        const inv = parseFloat(document.getElementById('investment').value) || 0;
        const period = parseFloat(document.getElementById('period').value) || 1;
        let inputValue = parseFloat(document.getElementById('expectedProfit').value) || 0;

        if (inv <= 0) { alert("íˆ¬ì ì›ê¸ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

        let profit = inputValue;
        let requiredProfit = 0;
        let requiredSalePrice = 0;

        // ì—­ê³„ì‚° ëª¨ë“œ: ëª©í‘œ ìˆœìˆ˜ìµìœ¼ë¡œë¶€í„° í•„ìš” ì‹œì„¸ì°¨ìµ ê³„ì‚°
        if (isTargetNetMode) {
            const targetNet = inputValue;
            requiredProfit = reverseCalculateProfit(targetNet, inv, period);
            profit = requiredProfit;

            // ë¶€ë™ì‚°ì¸ ê²½ìš° í•„ìš” ë§¤ë„ê°€ ê³„ì‚°
            if (currentInvestType === 'realestate') {
                const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
                requiredSalePrice = buyPrice + requiredProfit;
            } else {
                requiredSalePrice = inv + requiredProfit;
            }

            document.getElementById('requiredProfit').innerText = Math.round(requiredProfit).toLocaleString();
            document.getElementById('requiredSalePrice').innerText = Math.round(requiredSalePrice).toLocaleString();
            document.getElementById('reverseCalcResult').style.display = 'block';
        } else {
            document.getElementById('reverseCalcResult').style.display = 'none';
        }

        let totalExp = 0;
        let interest = 0;
        let rows = "";

        if (currentInvestType === 'realestate') {
            // ë¶€ë™ì‚° ê³„ì‚°
            const loan = parseFloat(document.getElementById('loan').value) || 0;
            const rate = (parseFloat(document.getElementById('rate').value) || 0) / 100;
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const isExempt = document.getElementById('isExempt').value === 'y';
            const salePrice = buyPrice + profit;
            const additionalExp = parseFloat(document.getElementById('additionalExpense').value) || 0;
            const residencePeriod = parseFloat(document.getElementById('residencePeriod').value) || 0;

            interest = loan * rate * period;

            let acqRate = (buyPrice <= 6e8) ? 0.01 : (buyPrice <= 9e8) ? (buyPrice * (2/3e8) - 3) / 100 : 0.03;
            const acq = Math.floor(buyPrice * acqRate);
            const edu = Math.floor(acq * 0.1);
            const legalFees = 880000 + 150000 + 18000;
            const brokerBuy = (buyPrice <= 9e8) ? buyPrice * 0.004 * 1.1 : buyPrice * 0.005 * 1.1;
            const brokerSell = brokerBuy;
            const buyExp = acq + edu + legalFees + brokerBuy;

            // ì–‘ë„ì„¸ ê³„ì‚° (í•„ìš”ê²½ë¹„ = ì¤‘ê°œë¹„ + ì¶”ê°€ë¹„ìš©)
            const necessaryExpenses = brokerBuy + brokerSell + additionalExp;
            const taxObj = calculateTax(profit, period, isExempt, salePrice, additionalExp, residencePeriod);
            totalExp = buyExp + brokerSell + additionalExp + taxObj.tax;

            rows += `<tr class="row-group"><td colspan="2">1. ë¶€ë™ì‚° ê±°ë˜ ê²½ë¹„ ëª…ì„¸</td></tr>`;
            rows += `<tr><td>ì·¨ë“ì„¸ ë° êµìœ¡ì„¸</td><td>${(acq + edu).toLocaleString()}ì›</td></tr>`;
            rows += `<tr><td>ë²•ë¬´ì‚¬ ë° ë¶€ëŒ€ë¹„ìš©</td><td>${legalFees.toLocaleString()}ì›</td></tr>`;
            rows += `<tr><td>ë¶€ë™ì‚° ì¤‘ê°œìˆ˜ìˆ˜ë£Œ</td><td>${(brokerBuy + brokerSell).toLocaleString()}ì› (2íšŒ)</td></tr>`;
            if (additionalExp > 0) {
                rows += `<tr><td>ì¶”ê°€ í•„ìš”ê²½ë¹„</td><td>${additionalExp.toLocaleString()}ì›</td></tr>`;
            }

            // ì–‘ë„ì„¸ ìƒì„¸ ë‚´ì—­ í‘œì‹œ
            if (taxObj.details) {
                const d = taxObj.details;
                rows += `<tr class="row-group"><td colspan="2">2. ì–‘ë„ì†Œë“ì„¸ ê³„ì‚° ë‚´ì—­</td></tr>`;
                rows += `<tr><td>ì „ì²´ ì–‘ë„ì°¨ìµ</td><td>${Math.round(d.totalGain).toLocaleString()}ì›</td></tr>`;
                if (salePrice > 12e8) {
                    rows += `<tr><td>ê³¼ì„¸ëŒ€ìƒ ì–‘ë„ì°¨ìµ (12ì–µ ì´ˆê³¼ë¶„)</td><td>${Math.round(d.taxableGain).toLocaleString()}ì›</td></tr>`;
                }
                rows += `<tr><td>ì¥ê¸°ë³´ìœ íŠ¹ë³„ê³µì œìœ¨</td><td>${Math.round(d.longTermRate * 100)}%</td></tr>`;
                rows += `<tr><td>ì–‘ë„ì†Œë“ê¸ˆì•¡ (ê³µì œ í›„)</td><td>${Math.round(d.incomeAmount).toLocaleString()}ì›</td></tr>`;
                rows += `<tr><td>ê³¼ì„¸í‘œì¤€ (âˆ’250ë§Œì›)</td><td>${Math.round(d.taxBase).toLocaleString()}ì›</td></tr>`;
                const deductionText = d.taxDeduction > 0 ? ` âˆ’${d.taxDeduction}ë§Œì›` : '';
                rows += `<tr><td>ì‚°ì¶œì„¸ì•¡ (${d.taxRate}%${deductionText})</td><td>${Math.round(d.taxBeforeLocal).toLocaleString()}ì›</td></tr>`;
                rows += `<tr class="row-tax"><td>ìµœì¢… ì–‘ë„ì„¸ (Ã—1.1 ì§€ë°©ì„¸)</td><td>${taxObj.tax.toLocaleString()}ì›</td></tr>`;
            } else {
                rows += `<tr class="row-tax"><td>ì–‘ë„ì†Œë“ì„¸ (${taxObj.label})</td><td>${taxObj.tax.toLocaleString()}ì›</td></tr>`;
            }

        } else if (currentInvestType === 'stock-kr') {
            // êµ­ë‚´ì£¼ì‹ ê³„ì‚°
            const feeRate = (parseFloat(document.getElementById('krFeeRate').value) || 0) / 100;
            const taxRate = (parseFloat(document.getElementById('krTaxRate').value) || 0) / 100;

            const buyFee = Math.floor(inv * feeRate); // ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ
            const sellAmount = inv + profit;
            const sellFee = Math.floor(sellAmount * feeRate); // ë§¤ë„ ìˆ˜ìˆ˜ë£Œ
            const tradeTax = Math.floor(sellAmount * taxRate); // ê±°ë˜ì„¸ (ë§¤ë„ì‹œ)

            totalExp = buyFee + sellFee + tradeTax;

            rows += `<tr class="row-group"><td colspan="2">1. êµ­ë‚´ì£¼ì‹ ê±°ë˜ ë¹„ìš©</td></tr>`;
            rows += `<tr><td>ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ (${(feeRate*100).toFixed(3)}%)</td><td>${buyFee.toLocaleString()}ì›</td></tr>`;
            rows += `<tr><td>ë§¤ë„ ìˆ˜ìˆ˜ë£Œ (${(feeRate*100).toFixed(3)}%)</td><td>${sellFee.toLocaleString()}ì›</td></tr>`;
            rows += `<tr><td>ê±°ë˜ì„¸ (${(taxRate*100).toFixed(2)}%)</td><td>${tradeTax.toLocaleString()}ì›</td></tr>`;
            rows += `<tr><td>ì–‘ë„ì†Œë“ì„¸</td><td>ë¹„ê³¼ì„¸ (ì¼ë°˜ ê°œì¸)</td></tr>`;

        } else if (currentInvestType === 'stock-us') {
            // ë¯¸êµ­ì£¼ì‹ ê³„ì‚°
            const feeRate = (parseFloat(document.getElementById('usFeeRate').value) || 0) / 100;
            const exchangeRate = (parseFloat(document.getElementById('usExchangeRate').value) || 0) / 100;

            const buyFee = Math.floor(inv * feeRate); // ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ
            const buyExchange = Math.floor(inv * exchangeRate); // ë§¤ìˆ˜ í™˜ì „
            const sellAmount = inv + profit;
            const sellFee = Math.floor(sellAmount * feeRate); // ë§¤ë„ ìˆ˜ìˆ˜ë£Œ
            const sellExchange = Math.floor(sellAmount * exchangeRate); // ë§¤ë„ í™˜ì „

            const taxObj = calculateUsStockTax(profit);

            totalExp = buyFee + buyExchange + sellFee + sellExchange + taxObj.tax;

            rows += `<tr class="row-group"><td colspan="2">1. ë¯¸êµ­ì£¼ì‹ ê±°ë˜ ë¹„ìš©</td></tr>`;
            rows += `<tr><td>ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ (${(feeRate*100).toFixed(2)}%)</td><td>${buyFee.toLocaleString()}ì›</td></tr>`;
            rows += `<tr><td>ë§¤ìˆ˜ í™˜ì „ (${(exchangeRate*100).toFixed(2)}%)</td><td>${buyExchange.toLocaleString()}ì›</td></tr>`;
            rows += `<tr><td>ë§¤ë„ ìˆ˜ìˆ˜ë£Œ (${(feeRate*100).toFixed(2)}%)</td><td>${sellFee.toLocaleString()}ì›</td></tr>`;
            rows += `<tr><td>ë§¤ë„ í™˜ì „ (${(exchangeRate*100).toFixed(2)}%)</td><td>${sellExchange.toLocaleString()}ì›</td></tr>`;
            rows += `<tr class="row-tax"><td>ì–‘ë„ì†Œë“ì„¸ (${taxObj.label})</td><td>${taxObj.tax.toLocaleString()}ì›</td></tr>`;
            rows += `<tr><td colspan="2" style="font-size:11px; color:#888; text-align:left;">* 250ë§Œì› ê¸°ë³¸ê³µì œ í›„ 22% (ì†Œë“ì„¸ 20% + ì§€ë°©ì„¸ 2%)</td></tr>`;

        } else if (currentInvestType === 'other') {
            // ê¸°íƒ€ íˆ¬ì
            const loan = parseFloat(document.getElementById('loan').value) || 0;
            const rate = (parseFloat(document.getElementById('rate').value) || 0) / 100;
            const otherFee = parseFloat(document.getElementById('otherFee').value) || 0;
            const otherTax = parseFloat(document.getElementById('otherTax').value) || 0;

            interest = loan * rate * period;
            totalExp = otherFee + otherTax;

            rows += `<tr class="row-group"><td colspan="2">1. ê¸°íƒ€ íˆ¬ì ë¹„ìš©</td></tr>`;
            rows += `<tr><td>ìˆ˜ìˆ˜ë£Œ/ë¹„ìš©</td><td>${otherFee.toLocaleString()}ì›</td></tr>`;
            rows += `<tr class="row-tax"><td>ì„¸ê¸ˆ</td><td>${otherTax.toLocaleString()}ì›</td></tr>`;
        }

        const netProfit = profit - totalExp - interest;
        const annualROI = (netProfit / (inv * period)) * 100;

        document.getElementById('f-profit').innerText = Math.round(profit).toLocaleString();
        document.getElementById('f-exp').innerText = Math.round(totalExp).toLocaleString();
        document.getElementById('f-int').innerText = Math.round(interest).toLocaleString();
        document.getElementById('f-inv').innerText = inv.toLocaleString();
        document.getElementById('f-period').innerText = period;
        document.getElementById('f-result').innerText = annualROI.toFixed(2) + "%";

        document.getElementById('resNet').innerText = Math.round(netProfit).toLocaleString() + "ì›";
        document.getElementById('resAnnualROI').innerText = annualROI.toFixed(2) + "%";

        // ì—­ê³„ì‚° ëª¨ë“œì—ì„œ ì¶”ê°€ ì •ë³´ í‘œì‹œ
        if (isTargetNetMode) {
            rows = `<tr class="row-group" style="background:#fff3e0;"><td colspan="2">ğŸ“Œ ì—­ê³„ì‚° ê²°ê³¼</td></tr>` +
                   `<tr style="background:#fff8e1;"><td>ëª©í‘œ ì‹¤ìˆ˜ë ¹ì•¡</td><td style="color:var(--orange); font-weight:bold;">${Math.round(inputValue).toLocaleString()}ì›</td></tr>` +
                   `<tr style="background:#fff8e1;"><td>í•„ìš” ì‹œì„¸ì°¨ìµ</td><td>${Math.round(requiredProfit).toLocaleString()}ì›</td></tr>` +
                   `<tr style="background:#fff8e1;"><td>ëª©í‘œ ë§¤ë„ê°€</td><td style="color:#e91e63; font-weight:bold;">${Math.round(requiredSalePrice).toLocaleString()}ì›</td></tr>` + rows;
        }

        // ê¸ˆìœµ ë¹„ìš© (ëŒ€ì¶œì´ì) ì¶”ê°€
        if (interest > 0) {
            const isExemptVal = document.getElementById('isExempt').value === 'y';
            const finSectionNum = (currentInvestType === 'realestate' && !isExemptVal) ? 3 : 2;
            rows += `<tr class="row-group"><td colspan="2">${finSectionNum}. ê¸ˆìœµ ë¹„ìš©</td></tr>`;
            rows += `<tr><td>ì´ ëŒ€ì¶œ ì´ì (${period}ë…„)</td><td>${Math.round(interest).toLocaleString()}ì›</td></tr>`;
        }

        document.getElementById('tableBody').innerHTML = rows;
        document.getElementById('roiHeader').style.display = 'block';
        document.getElementById('analysisTable').style.display = 'table';
    }
</script>
</body>
</html>

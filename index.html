<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>부태리 계산기 허브 – 3개 탭</title>
  <style>
    :root {
      --bg: #0b0c10;
      --card: #151822;
      --text: #e8eaf0;
      --muted: #96a0b5;
      --accent: #4caf50;
      --accent-weak: #3a8f40;
      --tab: #1b1f2b;
      --tab-active: #243049;
      --ring: rgba(76, 175, 80, 0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Apple SD Gothic Neo", "Malgun Gothic", Helvetica, Arial, "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b0c10 0%, #0f1220 100%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: saturate(150%) blur(8px);
      background: rgba(11,12,16,0.6);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .wrap { max-width: 1080px; margin: 0 auto; padding: 18px 16px; }
    h1 { margin: 0; font-size: clamp(20px, 2.8vw, 28px); letter-spacing: -0.2px; }
    .sub { color: var(--muted); font-size: 13px; }

    /* 상단 타이틀 + 방문수 배지 한 줄 정렬 */
    .header-top {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      margin-bottom: 4px;
    }
    /* 방문수 배지(다크 테마) */
    #daily-visitors{
      display:inline-flex; align-items:center; gap:.45em;
      padding:.38em .7em; border-radius:999px;
      background:var(--tab); color:var(--text);
      border:1px solid rgba(255,255,255,0.08);
      font-weight:700; font-size:13px;
    }

    .tabs {
      display: flex; gap: 8px; flex-wrap: wrap; margin-top: 14px;
    }
    [role="tab"] {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.06);
      background: var(--tab);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all .18s ease;
    }
    [role="tab"].active { background: var(--tab-active); border-color: var(--accent-weak); box-shadow: 0 0 0 3px var(--ring) inset; }
    [role="tab"]:hover { transform: translateY(-1px); }

    .panel {
      margin: 18px auto 28px; background: var(--card);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 18px;
      padding: 10px; /* keep slim; inner is iframe */
      overflow: hidden;
    }
    .panel[hidden] { display: none; }

    iframe {
      width: 100% ; border: 0; border-radius: 12px;
      background: #fff; /* calculators use light theme */
      min-height: 1200px; /* fallback height */
    }

    footer.page {
      text-align: center; color: var(--muted); font-size: 13px; padding: 28px 0 36px; border-top: 1px solid rgba(255,255,255,0.06);
    }
    footer.page a { color: #cfe6ff; text-decoration: none; }
    footer.page a:hover { text-decoration: underline; }

    .help {
      margin-top: 10px; color: var(--muted); font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="header-top">
        <h1>부태리의 부동산 계산기</h1>
        <!-- ✅ 방문수 배지(CountAPI 성공 시 텍스트, 실패 시 이미지 배지로 자동 대체) -->
        <span id="daily-visitors" aria-live="polite" title="당일 중복 1회만 증가">오늘 방문 <span id="dv-num">…</span></span>
      </div>
      <div class="sub">부동산 투자 관련 계산기</div>
      <div class="tabs" role="tablist" aria-label="계산기 선택">
        <button id="tab-invest-loan" class="active" role="tab" aria-selected="true" aria-controls="panel-invest-loan">내 자산 + 연봉에 맞는 금액대</button>
        <button id="tab-cost" role="tab" aria-selected="false" aria-controls="panel-cost">부동산 매수 경비 계산기</button>
        <button id="tab-loan" role="tab" aria-selected="false" aria-controls="panel-loan">부동산 대출 계산기 </button>
      </div>
      <div class="help">💡 팁: </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Panel 1 -->
    <section id="panel-invest-loan" class="panel" role="tabpanel" aria-labelledby="tab-invest-loan">
      <iframe title="내 자산 + 연봉에 맞는 금액대" data-file="투자 가능 단지 찾기(대출계산기) r6.html" loading="eager"></iframe>
    </section>

    <!-- Panel 2 -->
    <section id="panel-cost" class="panel" role="tabpanel" aria-labelledby="tab-cost" hidden>
      <iframe title="부동산 매수 경비 계산기" data-file="1. 부동산 매수 경비 산출 계산기 -r2.html" loading="lazy"></iframe>
    </section>

    <!-- Panel 3 -->
    <section id="panel-loan" class="panel" role="tabpanel" aria-labelledby="tab-loan" hidden>
      <iframe title="부동산 대출 계산기" data-file="20250413대출계산기-r5.html" loading="lazy"></iframe>
    </section>

    <footer class="page">
      <div><strong>협업 및 수정 문의</strong> · <a href="https://litt.ly/richdadtechtree" target="_blank" rel="noopener">https://litt.ly/richdadtechtree</a></div>
    </footer>
  </main>

  <script>
    (function(){
      const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
      const panels = Array.from(document.querySelectorAll('[role="tabpanel"]'));

      function encodeSrc(iframe){
        if (iframe && !iframe.dataset.loaded) {
          try {
            iframe.src = encodeURI(iframe.dataset.file);
          } catch (e) {
            iframe.src = iframe.dataset.file; // fallback
          }
          iframe.dataset.loaded = 'true';
        }
      }

      function resizeIframe(iframe){
        // Same-origin에서만 동작
        try {
          const doc = iframe.contentWindow.document;
          const setHeight = () => {
            const h = Math.max(
              doc.body.scrollHeight,
              doc.documentElement.scrollHeight,
              1200
            );
            iframe.style.height = h + 'px';
          };
          setHeight();

          // 동적 컨텐츠 변화 대응
          const mo = new MutationObserver(() => setHeight());
          mo.observe(doc.documentElement, { childList: true, subtree: true, attributes: true });

          // 폰트 로딩/리사이즈 대응
          iframe.contentWindow.addEventListener('load', setHeight);
          window.addEventListener('resize', setHeight);
        } catch (e) {
          // 교차 출처면 고정 높이로 스크롤 사용
          // console.warn('자동 높이조절은 동일 출처에서만 가능:', e);
        }
      }

      function activateTab(tab){
        tabs.forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected','false');
          const p = document.getElementById(t.getAttribute('aria-controls'));
          if (p) p.hidden = true;
        });
        tab.classList.add('active');
        tab.setAttribute('aria-selected','true');
        const panel = document.getElementById(tab.getAttribute('aria-controls'));
        if (panel) {
          panel.hidden = false;
          const iframe = panel.querySelector('iframe');
          if (iframe) {
            encodeSrc(iframe);
            iframe.addEventListener('load', () => resizeIframe(iframe), { once: true });
          }
        }
        // 주소 해시 반영(선택사항)
        history.replaceState(null, '', '#' + tab.id.replace('tab-','')); 
      }

      tabs.forEach(t => t.addEventListener('click', () => activateTab(t)));

      // 초기 로드: 해시에 따라 탭 선택
      const hash = location.hash.replace('#','');
      const initial = hash ? document.getElementById('tab-' + hash) : tabs[0];
      activateTab(initial || tabs[0]);

      // 접근성: 좌우 화살표로 이동
      document.addEventListener('keydown', e => {
        if (!['ArrowLeft','ArrowRight'].includes(e.key)) return;
        const idx = tabs.findIndex(t => t.classList.contains('active'));
        const next = e.key === 'ArrowRight' ? (idx + 1) % tabs.length : (idx - 1 + tabs.length) % tabs.length;
        activateTab(tabs[next]);
        tabs[next].focus();
      });
    })();
  </script>

  <!-- ============================== -->
  <!-- 방문수: CountAPI + 중복 방지 + 실패 시 배지 대체 -->
  <!-- ============================== -->
  <script>
    (() => {
      const tz   = 'Asia/Seoul';
      const wrap = document.getElementById('daily-visitors');
      const num  = document.getElementById('dv-num');

      // 🔧 네임스페이스(브랜드/프로젝트명으로 바꾸세요)
      const NS = 'buteri'; // 예: 'buteri-calc', 'richdadtechtree'

      // 페이지 슬러그(도메인+경로 → 안전한 문자열)
      const slug = (location.hostname + location.pathname)
        .replace(/[^a-z0-9]+/gi,'_').replace(/^_+|_+$/g,'').toLowerCase() || 'home';

      // YYYY-MM-DD (서울 기준)
      const today = new Intl.DateTimeFormat('en-CA', {
        timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit'
      }).format(new Date());

      // ▶ 키 = [페이지별] × [하루]
      // 누적(총 방문)으로 쓰려면 아래 줄을: const KEY = `${slug}__total`;
      const KEY = `${slug}__${today}`;

      // ---- 중복 방지(로컬스토리지 + 쿠키) ----
      const lsFlag = `pvflag_${KEY}`;
      const hasLS = () => !!localStorage.getItem(lsFlag);
      const setLS = () => localStorage.setItem(lsFlag, '1');
      const clearLS = () => localStorage.removeItem(lsFlag);

      const hasCookie = () => document.cookie.includes(`pvck_${KEY}=1`);
      const setCookie = () => document.cookie = `pvck_${KEY}=1; Max-Age=86400; Path=/; SameSite=Lax`;
      const clearCookie = () => document.cookie = `pvck_${KEY}=; Max-Age=0; Path=/; SameSite=Lax`;

      const hasFlag = () => hasLS() || hasCookie();
      const setFlag = () => { setLS(); setCookie(); };
      const clearFlag = () => { clearLS(); clearCookie(); };

      const setNum = (v) => { if (num) num.textContent = Number(v || 0).toLocaleString(); };
      const timeout = (ms) => new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), ms));

      async function countapi(mode) {
        const url = `https://api.countapi.xyz/${mode}/${encodeURIComponent(NS)}/${encodeURIComponent(KEY)}`;
        const res = await Promise.race([ fetch(url, { cache: 'no-store' }), timeout(2500) ]);
        if (!res.ok) throw new Error('countapi http ' + res.status);
        const j = await res.json();
        return j.value;
      }

      function fallbackBadge() {
        // CountAPI가 차단/지연이면 이미지 배지로 대체(숫자 계속 표시)
        const track = encodeURIComponent(`https://${location.host}${location.pathname}`);
        const img = new Image();
        img.src = `https://myhits.vercel.app/api/hit/${track}?label=${encodeURIComponent('오늘 방문')}&size=small`;
        img.alt = '오늘 방문수';
        img.style.display = 'inline-block';
        img.style.verticalAlign = 'middle';
        wrap.replaceWith(img);
      }

      (async () => {
        const firstToday = !hasFlag();
        try {
          if (firstToday) {
            // 선플래그(동시 오픈 방지) → 서버 hit
            setFlag();
            const hit = await countapi('hit');
            setNum(hit ?? 1);
          } else {
            // 이미 방문한 브라우저면 조회만
            const val = await countapi('get');
            setNum(val ?? 0);
          }
        } catch (err) {
          // 실패 시 선플래그 롤백 + 배지 대체
          if (firstToday) clearFlag();
          fallbackBadge();
        }
      })();
    })();
  </script>

  <noscript>
    <p style="text-align:center;color:#96a0b5">자바스크립트를 켜야 방문수를 표시할 수 있어요.</p>
  </noscript>
</body>
</html>

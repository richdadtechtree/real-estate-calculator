<script>
  /* ====== 한국시간 오늘 키 (이미 있으시면 이 부분은 생략) ====== */
  function todayKeySeoul(){
    try {
      const f = new Intl.DateTimeFormat('en-CA', { timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' });
      return f.format(new Date()); // YYYY-MM-DD
    } catch (e) {
      const d = new Date(Date.now() + 9*60*60*1000);
      return d.toISOString().slice(0,10);
    }
  }

  /* ====== CountAPI JSONP 유틸 ====== */
  function countApiJsonp(url, timeout=4000){
    return new Promise((resolve, reject) => {
      const cb = 'countapi_cb_' + Math.random().toString(36).slice(2);
      const s = document.createElement('script');
      let done = false;
      function cleanup(){
        if (done) return;
        done = true;
        try { delete window[cb]; } catch(_){}
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      const tm = setTimeout(() => { cleanup(); reject(new Error('JSONP timeout')); }, timeout);
      window[cb] = (data) => { clearTimeout(tm); cleanup(); resolve(data); };
      s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb + '&t=' + Date.now();
      s.onerror = () => { clearTimeout(tm); cleanup(); reject(new Error('JSONP error')); };
      document.head.appendChild(s);
    });
  }

  /* ====== 방문자수 (CountAPI + JSONP 폴백 + 로컬 폴백) ====== */
  async function updateVisitorCount_CountAPI(){
    const el = document.getElementById('visitor-count');
    const day = todayKeySeoul();

    // namespace: 도메인, key: 경로 + 날짜 / 누적
    const ns = (location.host || 'site').replace(/[^a-z0-9.-]/gi,'_').toLowerCase(); // richdadtechtree.github.io
    const basePath = (location.pathname || '/')
      .replace(/^\/|\/$/g,'')       // 앞뒤 슬래시 제거
      .replace(/[^a-z0-9.-]/gi,'_') // 안전한 문자만
      .toLowerCase() || 'root';     // real-estate-calculator

    const dailyKey = basePath + '__' + day;   // 예: real-estate-calculator__2025-09-16
    const totalKey = basePath + '__total';    // 예: real-estate-calculator__total

    const urlDaily = `https://api.countapi.xyz/hit/${encodeURIComponent(ns)}/${encodeURIComponent(dailyKey)}?amount=1`;
    const urlTotal = `https://api.countapi.xyz/hit/${encodeURIComponent(ns)}/${encodeURIComponent(totalKey)}?amount=1`;

    function render(dailyVal, totalVal){
      el.textContent = Number(dailyVal).toLocaleString('ko-KR');
      el.setAttribute('title', `누적 합계: ${Number(totalVal).toLocaleString('ko-KR')}회 (기준일 ${day})`);
    }

    try {
      // 1차: fetch(JSON)
      const [r1, r2] = await Promise.all([
        fetch(urlDaily, { cache:'no-store' }),
        fetch(urlTotal, { cache:'no-store' })
      ]);
      if (!r1.ok || !r2.ok) throw new Error('fetch not ok');
      const d1 = await r1.json();
      const d2 = await r2.json();
      if (typeof d1.value !== 'number' || typeof d2.value !== 'number') throw new Error('bad data');
      render(d1.value, d2.value);
    } catch (errFetch) {
      // 2차: JSONP 폴백 (CORS/차단 회피)
      try {
        const d1 = await countApiJsonp(urlDaily);
        const d2 = await countApiJsonp(urlTotal);
        if (typeof d1.value !== 'number' || typeof d2.value !== 'number') throw new Error('jsonp bad data');
        render(d1.value, d2.value);
      } catch (errJsonp) {
        // 3차: 로컬 폴백 (브라우저별)
        try {
          const stored = JSON.parse(localStorage.getItem('visit-count') || '{}');
          stored[day] = (stored[day] || 0) + 1;
          localStorage.setItem('visit-count', JSON.stringify(stored));
          el.textContent = stored[day];
          el.setAttribute('title', '전역 합계 서버 연결 실패: 임시 로컬 카운트');
        } catch (e2) {
          el.textContent = '–';
        }
      }
    }
  }

  // 페이지 로드시 전역 카운트 +1
  updateVisitorCount_CountAPI();
</script>
